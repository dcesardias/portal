<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Power BI</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="assets/css/portal.css">
</head>
<body>
    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <img id="sidebarLogo" class="logo-image" style="display: none;" alt="Logo">
                    <div class="sidebar-title">Power BI Dashboard</div>
                </div>
                <span class="close-btn" id="sidebarCloseBtn" title="Alternar menu"></span>
            </div>
            <div id="menuContainer"></div>
            <div class="sidebar-footer">
                <button class="btn btn-admin" id="adminButton" onclick="toggleAdmin()">Configura√ß√µes</button>
            </div>
        </div>

        <div class="main-content">
            <div class="header">
                <div>
                    <div class="page-title" id="pageTitle">Power BI Dashboard</div>
                    <div class="page-subtitle" id="pageSubtitle">Vis√£o geral do portal de relat√≥rios</div>
                </div>
                <!-- Search UI with Dark Mode Toggle -->
                <div class="search-container">
                    <input id="searchInput" 
                           name="q_search_portal_2025" 
                           class="search-input" 
                           type="text" 
                           placeholder="Buscar p√°ginas..." 
                           autocomplete="off"
                           autocorrect="off" 
                           autocapitalize="off" 
                           spellcheck="false"
                           aria-label="Buscar p√°ginas"
                           role="searchbox"
                           data-lpignore="true"
                           data-form-type="other" />
                    <button id="themeToggle" 
                            class="theme-toggle" 
                            title="Alternar tema claro/escuro"
                            aria-label="Alternar entre modo claro e escuro">
                        <span class="icon sun-icon">‚òÄÔ∏è</span>
                        <span class="icon moon-icon">üåô</span>
                    </button>
                    <div id="searchResults" class="search-results"></div>
                </div>
            </div>
            <div class="content" id="mainContent">
                <!-- Home view (padr√£o) -->
                <div id="homeView">
                    <div class="info-card" style="margin-bottom:20px;">
                        <h3>Bem-vindo ao Portal</h3>
                        <p id="homeSubtitle">Navegue pelos pain√©is e dashboards dispon√≠veis. Selecione um card abaixo ou use o menu lateral.</p>
                    </div>

                    <div class="cards-section">
                        <h2 style="color: var(--text-color); margin-bottom: 20px; font-size: 20px;">Acesso R√°pido aos Pain√©is</h2>
                        <div id="quickAccessCards" class="cards-grid">
                            <!-- Cards ser√£o inseridos aqui dinamicamente -->
                        </div>
                    </div>
                </div>

                <!-- Page view (quando uma p√°gina for selecionada) -->
                <div id="pageView" style="display:none;">
                    <div class="info-card">
                        <p id="pageDescription">Este painel oferece uma vis√£o abrangente das m√©tricas...</p>
                    </div>
                    <div style="position:relative;">
                        <!-- NOVO: Bot√£o para iniciar tutorial -->
                        <button id="startTutorialBtn" class="btn-start-tutorial" style="display:none;" title="Iniciar tutorial desta p√°gina">
                            <i class="fas fa-graduation-cap"></i>
                            Tutorial
                        </button>
                        
                        <button id="refreshIframeBtn" class="btn-refresh-iframe" style="display:none;" title="Atualizar painel">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <div class="powerbi-container" id="powerbiContainer">
                            <div class="placeholder">
                                <div class="powerbi-icon">üìä</div>
                                <h3 style="color: #666; margin-bottom:10px;">Power BI</h3>
                                <p style="color: #999; margin-bottom:20px;">Entre para ver este relat√≥rio</p>
                                <button class="btn">Entrar</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="overlay" id="overlay"></div>

            <div class="login-modal" id="loginModal">
        <div class="login-header">
            <h2>Login Administrativo</h2>
        </div>
        <div class="error-message" id="loginError"></div>
        <input type="text" name="username_fake" style="position:absolute;left:-9999px;" tabindex="-1" autocomplete="username">
        <div class="form-group">
            <label>Usu√°rio</label>
            <input type="text" id="loginUsername" name="admin_username" placeholder="Digite seu usu√°rio" autocomplete="username">
        </div>
        <div class="form-group">
            <label>Senha</label>
            <input type="password" id="loginPassword" name="admin_password" placeholder="Digite sua senha" autocomplete="current-password">
        </div>
        <button class="btn btn-admin" style="width: 100%;" id="loginButton">Entrar</button>
    </div>

    <div class="admin-panel" id="adminPanel">
        <div class="resize-handle" id="resizeHandle"></div>
        <div class="admin-header">
            <h2>Painel Administrativo</h2>
            <span class="close-btn" onclick="closeAdminPanel()">√ó</span>
        </div>
        <div class="admin-content">
            <div style="margin-bottom: 20px;">
                <button class="btn btn-logout" onclick="logout()">Sair do Admin</button>
            </div>
            
            <div class="tabs">
                <button class="tab active" onclick="switchTab('pages', event)">P√°ginas</button>
                <button class="tab" onclick="switchTab('menu', event)">Menu</button>
                <button class="tab" onclick="switchTab('dictionary', event)">Dicion√°rio IA</button>
                <button class="tab" onclick="switchTab('config', event)">Configura√ß√µes</button>
            </div>

            <div class="tab-content active" id="pagesTab">
                <h3>Gerenciar P√°ginas</h3>
                <div class="form-group">
                    <label>T√≠tulo da P√°gina</label>
                    <input type="text" id="pageNameInput" placeholder="Ex: Dashboard de Vendas">
                </div>
                <div class="form-group">
                    <label>Subt√≠tulo</label>
                    <input type="text" id="pageSubtitleInput" placeholder="Ex: An√°lise detalhada de vendas">
                </div>
                <div class="form-group">
                    <label>Descri√ß√£o</label>
                    <textarea id="pageDescInput" placeholder="Descri√ß√£o detalhada da p√°gina..."></textarea>
                </div>
                <div class="form-group">
                    <label>URL do Power BI Embed</label>
                    <input type="text" id="powerbiUrlInput" placeholder="https://app.powerbi.com/view?r=...">
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="showInHomeCheckbox" checked style="width: auto;">
                        <span>Mostrar na tela inicial (Acesso R√°pido)</span>
                    </label>
                    <small style="color: #666; display: block; margin-top: 4px;">
                        Marque para exibir esta p√°gina nos cards de acesso r√°pido da tela inicial
                    </small>
                </div>
                <div class="form-group">
                    <label>√çcone do Card (opcional)</label>
                    <div style="display:flex;align-items:center;gap:8px;">
                        <input type="text" id="pageIconInput" placeholder="Ex: üìä ou escolha abaixo" style="flex:1;">
                        <div id="pageIconPreview" class="icon-preview" title="Preview do √≠cone"></div>
                    </div>
                    <div id="pageIconDropdown" style="position:relative;margin-top:8px;">
                        <div id="pageIconDropdownToggle" style="width:100%;padding:8px;border-radius:4px;border:1px solid #ddd;background:#fff;cursor:pointer;display:flex;align-items:center;justify-content:space-between;">
                            <span id="pageIconDropdownSelected" style="display:flex;align-items:center;gap:8px;">
                                <span style="color:#999;">Selecione um √≠cone...</span>
                            </span>
                            <span style="transform:rotate(90deg);color:#666;">‚Ä∫</span>
                        </div>
                        <div id="pageIconDropdownMenu" style="display:none;position:absolute;top:100%;left:0;right:0;max-height:200px;overflow-y:auto;background:#fff;border:1px solid #ddd;border-radius:4px;margin-top:4px;z-index:1000;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                        </div>
                    </div>
                    <small style="color: #666; display: block; margin-top: 8px;">
                        Este √≠cone aparecer√° no card de acesso r√°pido na tela inicial
                    </small>
                </div> 
                <div style="display:flex;gap:10px;">
                    <button class="btn btn-admin" id="savePageBtn" onclick="savePage()">Salvar P√°gina</button>
                    <button class="btn" id="cancelPageEditBtn" style="display:none;background:#ccc;color:#000;" onclick="cancelPageEdit()">Cancelar</button>
                </div>
                
                <h4 style="margin-top: 30px;">P√°ginas Existentes</h4>
                <div style="margin-bottom: 10px; padding: 8px; background: #e8f5e8; border-radius: 4px; font-size: 12px; color: #2e7d32;">
                    üí° <strong>Ordena√ß√£o dos Cards:</strong> Use as setas ‚Üë‚Üì para alterar a ordem dos cards na tela inicial. A ordena√ß√£o afeta apenas p√°ginas marcadas como "Mostrar na tela inicial".
                </div>
                <div class="menu-list" id="pagesList"></div>
            </div>

            <div class="tab-content" id="menuTab">
                <h3>Gerenciar Menu</h3>
                <div class="form-group">
                    <label>Nome do Item</label>
                    <input type="text" id="menuItemInput" placeholder="Ex: Financeiro">
                </div>
                <div class="form-group">
                    <label>Tipo</label>
                    <select id="menuTypeSelect">
                        <option value="item">Item Simples</option>
                        <option value="category">Categoria (com subitens)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>√çcone (emoji ou classe)</label>
                    <div style="display:flex;align-items:center;gap:8px;">
                        <input type="text" id="menuIconInput" placeholder="Ex: üìä ou fas fa-chart" style="flex:1;">
                        <div id="menuIconPreview" class="icon-preview" title="Preview do √≠cone"></div>
                    </div>
                    <div id="iconDropdown" style="position:relative;margin-top:8px;">
                        <div id="iconDropdownToggle" style="width:100%;padding:8px;border-radius:4px;border:1px solid #ddd;background:#fff;cursor:pointer;display:flex;align-items:center;justify-content:space-between;">
                            <span id="iconDropdownSelected" style="display:flex;align-items:center;gap:8px;">
                                <span style="color:#999;">Selecione um √≠cone...</span>
                            </span>
                            <span style="transform:rotate(90deg);color:#666;">‚Ä∫</span>
                        </div>
                        <div id="iconDropdownMenu" style="display:none;position:absolute;top:100%;left:0;right:0;max-height:200px;overflow-y:auto;background:#fff;border:1px solid #ddd;border-radius:4px;margin-top:4px;z-index:1000;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                        </div>
                    </div>
                </div>
                <div class="form-group" id="parentSelectGroup" style="display: none;">
                    <label>Item Pai (Categoria)</label>
                    <select id="parentSelect">
                        <option value="">Nenhum (N√≠vel Principal)</option>
                    </select>
                    <small style="color: #666; display: block; margin-top: 4px;">
                        üí° Selecione uma categoria existente para criar subitens. Voc√™ pode criar m√∫ltiplos n√≠veis de hierarquia (n√≠vel 2, 3, etc.)
                    </small>
                </div>
                <div class="form-group" id="pageSelectGroup">
                    <label>P√°gina Associada</label>
                    <select id="pageSelect">
                        <option value="">Selecione uma p√°gina (apenas para itens simples)</option>
                    </select>
                    <small style="color: #666; display: block; margin-top: 4px;">
                        üí° Apenas itens simples podem ter p√°ginas associadas. Categorias servem apenas para organizar outros itens.
                    </small>
                </div>
                <div style="display:flex;gap:10px;">
                    <button class="btn btn-admin" id="saveMenuBtn" onclick="saveMenuItem()">Adicionar ao Menu</button>
                    <button class="btn" id="cancelMenuEditBtn" style="display:none;background:#ccc;color:#000;" onclick="cancelMenuEdit()">Cancelar</button>
                </div>
                
                <h4 style="margin-top: 30px;">Estrutura do Menu</h4>
                <div style="margin-bottom: 10px; padding: 8px; background: #e3f2fd; border-radius: 4px; font-size: 12px; color: #1565c0;">
                    üí° <strong>Hierarquia Multin√≠vel:</strong> Voc√™ pode criar subitens dentro de subitens sem limite de profundidade. Categorias podem conter outras categorias e itens.
                </div>
                <div class="menu-list" id="menuStructure"></div>
            </div>

            <div class="tab-content" id="configTab">
                <h3>Configura√ß√µes do Portal</h3>
                <!-- Logo Upload Section (primeiro campo) -->
                <div class="form-group">
                    <label>Logo do Portal</label>
                    <div class="logo-upload-section">
                        <div class="logo-preview">
                            <div id="logoPreviewContainer">
                                <div class="logo-placeholder">Logo</div>
                            </div>
                            <div>
                                <strong>Logo atual</strong>
                                <br>
                                <small style="color: #666;">Recomendado: PNG transparente, 32x32px a 64x32px</small>
                            </div>
                        </div>
                        <div class="upload-controls">
                            <div class="file-input-wrapper">
                                <input type="file" id="logoUpload" accept="image/png,image/jpeg,image/jpg,image/gif,image/svg+xml">
                                <button class="btn-upload" onclick="document.getElementById('logoUpload').click()">
                                    Selecionar Logo
                                </button>
                            </div>
                            <button class="btn-remove-logo" id="removeLogo" onclick="removeLogo()" style="display: none;">
                                Remover Logo
                            </button>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Tamanho do Logo (px)</label>
                    <input type="number" id="logoSizeInput" min="16" max="128" value="48" style="width:100%;margin-top:6px;">
                </div>
                <div class="form-group">
                    <label>Nome do Portal</label>
                    <input type="text" id="portalName" value="Power BI Dashboard">
                </div>
                <div class="form-group">
                    <label>Nome do item "Home" no Menu</label>
                    <input type="text" id="homeMenuName" placeholder="Ex: In√≠cio" value="Home">
                </div>
                <div class="form-group">
                    <label>√çcone do item "Home" (emoji ou classe)</label>
                    <div style="display:flex;align-items:center;gap:8px;">
                        <input type="text" id="homeIconInput" placeholder="Ex: üè† ou fas fa-home" style="flex:1;">
                        <div id="homeIconPreview" class="icon-preview" title="Preview do √≠cone Home"></div>
                    </div>
                    <div id="homeIconDropdown" style="position:relative;margin-top:8px;">
                        <div id="homeIconDropdownToggle" style="width:100%;padding:8px;border-radius:4px;border:1px solid #ddd;background:#fff;cursor:pointer;display:flex;align-items:center;justify-content:space-between;">
                            <span id="homeIconDropdownSelected" style="display:flex;align-items:center;gap:8px;">
                                <span style="color:#999;">Selecione um √≠cone...</span>
                            </span>
                            <span style="transform:rotate(90deg);color:#666;">‚Ä∫</span>
                        </div>
                        <div id="homeIconDropdownMenu" style="display:none;position:absolute;top:100%;left:0;right:0;max-height:200px;overflow-y:auto;background:#fff;border:1px solid #ddd;border-radius:4px;margin-top:4px;z-index:1000;box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                        </div>
                    </div>
                </div>
				<div class="form-group">
					<label>Fonte - Nome do Portal</label>
					<select id="portalFontSelect">
						<option value="'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif">Segoe UI (padr√£o)</option>
						<option value="Arial, Helvetica, sans-serif">Arial</option>
						<option value="'Helvetica Neue', Helvetica, Arial, sans-serif">Helvetica Neue</option>
						<option value="'Roboto', sans-serif">Roboto</option>
						<option value="'Open Sans', sans-serif">Open Sans</option>
						<option value="'Lato', sans-serif">Lato</option>
						<option value="'Poppins', sans-serif">Poppins</option>
						<option value="'Montserrat', sans-serif">Montserrat</option>
						<option value="'Inter', sans-serif">Inter</option>
						<option value="'Nunito', sans-serif">Nunito</option>
						<option value="Georgia, serif">Georgia</option>
						<option value="'Times New Roman', Times, serif">Times New Roman</option>
						<option value="'Courier New', Courier, monospace">Courier New</option>
						<option value="'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif">SF Pro Display</option>
						<option value="Verdana, Geneva, sans-serif">Verdana</option>
						<option value="Tahoma, Geneva, sans-serif">Tahoma</option>
					</select>
					<div style="margin-top:8px;">
						<label style="font-weight:500;font-size:12px;">Tamanho (px)</label>
						<input type="number" id="portalFontSize" min="10" max="48" value="16" style="width:100%;margin-top:6px;">
						<label style="margin-top:8px;display:flex;align-items:center;gap:8px;">
							<input type="checkbox" id="portalFontBold" style="width:auto;">
							<span style="font-weight:500;font-size:12px;">Negrito</span>
						</label>
					</div>
				</div>
				<div class="form-group">
					<label>Fonte - Itens do Menu</label>
					<select id="menuFontSelect">
						<option value="'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif">Segoe UI (padr√£o)</option>
						<option value="Arial, Helvetica, sans-serif">Arial</option>
						<option value="'Helvetica Neue', Helvetica, Arial, sans-serif">Helvetica Neue</option>
						<option value="'Roboto', sans-serif">Roboto</option>
						<option value="'Open Sans', sans-serif">Open Sans</option>
						<option value="'Lato', sans-serif">Lato</option>
						<option value="'Poppins', sans-serif">Poppins</option>
						<option value="'Montserrat', sans-serif">Montserrat</option>
						<option value="'Inter', sans-serif">Inter</option>
						<option value="'Nunito', sans-serif">Nunito</option>
						<option value="Georgia, serif">Georgia</option>
						<option value="'Times New Roman', Times, serif">Times New Roman</option>
						<option value="'Courier New', Courier, monospace">Courier New</option>
						<option value="'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif">SF Pro Display</option>
						<option value="Verdana, Geneva, sans-serif">Verdana</option>
						<option value="Tahoma, Geneva, sans-serif">Tahoma</option>
					</select>
					<div style="margin-top:8px;">
						<label style="font-weight:500;font-size:12px;">Tamanho (px)</label>
						<input type="number" id="menuFontSize" min="10" max="32" value="14" style="width:100%;margin-top:6px;">
						<label style="margin-top:8px;display:flex;align-items:center;gap:8px;">
							<input type="checkbox" id="menuFontBold" style="width:auto;">
							<span style="font-weight:500;font-size:12px;">Negrito</span>
						</label>
						
						<label style="font-weight:500;font-size:12px;margin-top:12px;display:block;">Tamanho dos √çcones (px)</label>
						<input type="number" id="menuIconSize" min="12" max="32" value="18" style="width:100%;margin-top:6px;">
					</div>
				</div>
				<div class="form-group">
					<label>Fonte - P√°ginas (t√≠tulo/subt√≠tulo/descri√ß√£o)</label>
					<select id="pageFontSelect">
						<option value="'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif">Segoe UI (padr√£o)</option>
						<option value="Arial, Helvetica, sans-serif">Arial</option>
						<option value="'Helvetica Neue', Helvetica, Arial, sans-serif">Helvetica Neue</option>
						<option value="'Roboto', sans-serif">Roboto</option>
						<option value="'Open Sans', sans-serif">Open Sans</option>
						<option value="'Lato', sans-serif">Lato</option>
						<option value="'Poppins', sans-serif">Poppins</option>
						<option value="'Montserrat', sans-serif">Montserrat</option>
						<option value="'Inter', sans-serif">Inter</option>
						<option value="'Nunito', sans-serif">Nunito</option>
						<option value="Georgia, serif">Georgia</option>
						<option value="'Times New Roman', Times, serif">Times New Roman</option>
						<option value="'Courier New', Courier, monospace">Courier New</option>
						<option value="'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif">SF Pro Display</option>
						<option value="Verdana, Geneva, sans-serif">Verdana</option>
						<option value="Tahoma, Geneva, sans-serif">Tahoma</option>
					</select>
					<div style="margin-top:8px;">
						<label style="font-weight:500;font-size:12px;">Tamanho T√≠tulo (px)</label>
						<input type="number" id="pageTitleSize" min="12" max="64" value="24" style="width:100%;margin-top:6px;">
						<label style="margin-top:8px;display:flex;align-items:center;gap:8px;">
							<input type="checkbox" id="pageTitleBold" checked style="width:auto;">
							<span style="font-weight:500;font-size:12px;">T√≠tulo em Negrito</span>
						</label>
						
						<label style="font-weight:500;font-size:12px;margin-top:12px;display:block;">Tamanho Subt√≠tulo (px)</label>
						<input type="number" id="pageSubtitleSize" min="10" max="36" value="14" style="width:100%;margin-top:6px;">
						<label style="margin-top:8px;display:flex;align-items:center;gap:8px;">
							<input type="checkbox" id="pageSubtitleBold" style="width:auto;">
							<span style="font-weight:500;font-size:12px;">Subt√≠tulo em Negrito</span>
						</label>
						
						<label style="font-weight:500;font-size:12px;margin-top:12px;display:block;">Tamanho Descri√ß√£o (px)</label>
						<input type="number" id="pageDescSize" min="10" max="24" value="14" style="width:100%;margin-top:6px;">
						<label style="margin-top:8px;display:flex;align-items:center;gap:8px;">
							<input type="checkbox" id="pageDescBold" style="width:auto;">
							<span style="font-weight:500;font-size:12px;">Descri√ß√£o em Negrito</span>
						</label>
					</div>
				</div>
                <div class="form-group">
                    <label>Cor Prim√°ria</label>
                    <input type="color" id="primaryColor" value="#0066cc">
                </div>
                <div class="form-group">
                    <label>Cor do Menu</label>
                    <input type="color" id="menuBgColor" value="#4A4A4A">
                </div>
                <div class="form-group">
                    <label>Cor do Menu Colapsado</label>
                    <input type="color" id="menuCollapsedBgColor" value="#4A4A4A">
                </div>
                <div class="form-group">
                    <label>Cor de realce do bot√£o do Menu (hover)</label>
                    <input type="color" id="menuHoverColor" value="#2a2d4a">
                </div>
                <button class="btn btn-admin" onclick="saveConfig()">Salvar Configura√ß√µes</button>
                
                <div style="margin-top: 30px; padding: 15px; background: #fff3cd; border-radius: 4px;">
                    <h4 style="color: #856404; margin-bottom: 10px;">Informa√ß√µes do Sistema</h4>
                    <p style="color: #856404; font-size: 14px;">
                        ‚úÖ Portal conectado ao SQL Server<br>
                        ‚úÖ Usu√°rio admin autenticado<br>
                        ‚úÖ Modo de edi√ß√£o ativado
                    </p>
                </div>
            </div>

            <!-- Nova aba para Dicion√°rio de Dados -->
            <div class="tab-content" id="dictionaryTab">
                <h3>Gerenciar Dicion√°rios de Dados (IA)</h3>
                <p style="color: #666; font-size: 14px; margin-bottom: 20px;">
                    Configure os dicion√°rios de dados que o chatbot IA usar√° para gerar consultas SQL. 
                    O dicion√°rio padr√£o ser√° usado automaticamente pelo assistente.
                </p>

                <div style="margin-bottom: 20px;">
                    <button class="btn btn-admin" onclick="window.PortalAdmin.showCreateDictionaryForm()">
                        ‚ûï Novo Dicion√°rio
                    </button>
                </div>

                <!-- Lista de dicion√°rios existentes -->
                <h4>Dicion√°rios Existentes</h4>
                <div class="menu-list" id="dictionariesList">
                    <div style="text-align: center; color: #666; padding: 20px;">
                        Carregando dicion√°rios...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Tutorial Builder (abre dentro do portal) -->
    <div id="tutorialBuilderModal" style="display:none;position:fixed;inset:0;z-index:10050;backdrop-filter:blur(2px);background:rgba(0,0,0,0.55);">
        <div style="position:absolute;inset:30px;display:flex;flex-direction:column;">
            <div style="display:flex;justify-content:flex-end;margin-bottom:8px;">
                <button id="closeTutorialBuilderBtn" aria-label="Fechar" style="background:#fff;border:1px solid #ddd;border-radius:8px;padding:8px 12px;cursor:pointer;box-shadow:0 2px 10px rgba(0,0,0,0.2);">
                    √ó
                </button>
            </div>
            <div style="flex:1;min-height:0;background:#1f1f1f;border-radius:10px;overflow:hidden;border:1px solid #333;">
                <iframe id="tutorialBuilderIframe" src="" title="Tutorial Builder" style="width:100%;height:100%;border:0;display:block;"></iframe>
            </div>
        </div>
    </div>

    <script defer src="assets/js/app.js"></script>
    <script defer src="assets/js/modules/admin.js"></script>
    <script defer src="assets/js/modules/tutorial.js"></script>
    <script defer src="assets/js/chatbot.js"></script>
    
    <!-- Debug: Verificar se m√≥dulos carregaram -->
    <script>
        window.addEventListener('load', () => {
            setTimeout(() => {
                console.log('[DEBUG] M√≥dulos carregados:');
                console.log('  PortalApp:', !!window.PortalApp);
                console.log('  PortalAdmin:', !!window.PortalAdmin);
                console.log('  PortalTutorial:', !!window.PortalTutorial);
                
                if (!window.PortalTutorial) {
                    console.error('[DEBUG] ‚ö†Ô∏è PortalTutorial N√ÉO foi carregado!');
                }
            }, 1000);
        });
    </script>

    <!-- Patch savePage: avoid misleading error if only the reload fails -->
    <script>
    (function() {
        function getVal(id) { const el = document.getElementById(id); return el ? el.value : ''; }
        function isChecked(id) { const el = document.getElementById(id); return el ? !!el.checked : false; }
        function prep(val, max) {
            try { return (window.prepareStringForDb ? window.prepareStringForDb(val, max).value : (val || '')); }
            catch(_) { return val || ''; }
        }
        async function reloadSafely() {
            try { if (typeof window.loadDataFromAPI === 'function') await window.loadDataFromAPI(); }
            catch (e) { console.warn('[savePage] reload warning:', e); }
            try {
                if (window.selectedPageId === null && typeof window.loadQuickAccessCards === 'function') {
                    window.loadQuickAccessCards();
                }
            } catch (_) {}
        }

        // Override global savePage to improve UX/errors after save
        window.savePage = async function() {
            const title = getVal('pageNameInput').trim();
            if (!title) { alert('Por favor, preencha o t√≠tulo da p√°gina'); return; }

            const token = localStorage.getItem('authToken');
            if (!token) { alert('Fa√ßa login como administrador para salvar p√°ginas'); return; }

            const MAX = (window.MAX_LENGTHS || {});
            const payload = {
                title:       prep(title,                           MAX.pageTitle     || 200),
                subtitle:    prep(getVal('pageSubtitleInput'),     MAX.pageSubtitle  || 500),
                description: prep(getVal('pageDescInput'),         MAX.pageDescription || 4000),
                powerBIUrl:  prep(getVal('powerbiUrlInput'),       MAX.powerBIUrl    || 2000),
                showInHome:  isChecked('showInHomeCheckbox'),
                icon:        prep(getVal('pageIconInput'),         MAX.pageIcon      || 500) || null
            };

            const editingId = (typeof window.editingPageId !== 'undefined' && window.editingPageId) ? window.editingPageId : null;
            const url = editingId ? `${location.origin}/api/pages/${editingId}` : `${location.origin}/api/pages`;
            const method = editingId ? 'PUT' : 'POST';

            try {
                const resp = await fetch(url, {
                    method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!resp.ok) {
                    const body = await resp.text().catch(() => resp.statusText);
                    alert(`Erro ao salvar p√°gina: ${body || resp.statusText} (status ${resp.status})`);
                    return;
                }

                // Sucesso: limpar formul√°rio e estado de edi√ß√£o
                try { if (typeof window.clearPageForm === 'function') window.clearPageForm(); } catch (_) {}
                window.editingPageId = null;
                const btn = document.getElementById('savePageBtn'); if (btn) btn.textContent = 'Salvar P√°gina';
                const cancel = document.getElementById('cancelPageEditBtn'); if (cancel) cancel.style.display = 'none';

                // Recarregar dados sem falhar a opera√ß√£o de salvar
                await reloadSafely();
                alert(editingId ? 'P√°gina atualizada com sucesso!' : 'P√°gina salva com sucesso!');
            } catch (err) {
                console.error('[savePage] erro:', err);
                // Evitar mensagem enganosa: o erro pode ser apenas ao recarregar a UI
                alert(`N√£o foi poss√≠vel atualizar a interface ap√≥s salvar. Detalhes: ${err.message || err}`);
            }
        };
    })();
    </script>

    <!-- Patch: garantir que o tutorial use o iframe como refer√™ncia para posicionamento -->
    <script>
    (function () {
        function toPx(raw, total) {
            if (raw === undefined || raw === null) return 0;
            const s = String(raw).trim();
            if (s.endsWith('%')) {
                const p = parseFloat(s);
                return isNaN(p) ? 0 : (p / 100) * total;
            }
            if (s.endsWith('px')) {
                const n = parseFloat(s);
                return isNaN(n) ? 0 : n;
            }
            const n = parseFloat(s);
            if (isNaN(n)) return 0;
            if (n >= 0 && n <= 100) return (n / 100) * total;
            return n;
        }

        // Usar floats sem arredondar para manter sub-pixels e evitar drift
        function computeLocalRect(highlight, iw, ih) {
            let topPx = toPx(highlight.top, ih);
            let leftPx = toPx(highlight.left, iw);
            let widthPx = toPx(highlight.width, iw);
            let heightPx = toPx(highlight.height, ih);

            widthPx = Math.max(1, Math.min(widthPx, iw));
            heightPx = Math.max(1, Math.min(heightPx, ih));
            topPx = Math.max(0, Math.min(topPx, ih - heightPx));
            leftPx = Math.max(0, Math.min(leftPx, iw - widthPx));

            return { top: topPx, left: leftPx, width: widthPx, height: heightPx };
        }

        function makeOverlay() {
            const overlay = document.createElement('div');
            overlay.className = 'tutorial-overlay';
            overlay.style.pointerEvents = 'none';

            const frameBox = document.createElement('div');
            frameBox.className = 'tutorial-framebox';
            frameBox.style.pointerEvents = 'none';

            const highlight = document.createElement('div');
            highlight.className = 'tutorial-highlight';

            const tooltip = document.createElement('div');
            tooltip.className = 'tutorial-tooltip';
            tooltip.innerHTML = [
                '<div class="tutorial-tooltip-content">',
                '<button class="btn-tutorial-close" aria-label="Fechar">√ó</button>',
                '<h3></h3>',
                '<p></p>',
                '<div class="tutorial-footer">',
                '<span class="tutorial-progress"></span>',
                '<div class="tutorial-buttons">',
                '<button class="btn-tutorial btn-tutorial-prev">Anterior</button>',
                '<button class="btn-tutorial btn-tutorial-next">Pr√≥ximo</button>',
                '</div>',
                '</div>',
                '</div>'
            ].join('');

            frameBox.appendChild(highlight);
            overlay.appendChild(frameBox);
            overlay.appendChild(tooltip);
            document.body.appendChild(overlay);

            overlay._frameBox = frameBox;
            overlay._highlight = highlight;
            overlay._tooltip = tooltip;
            overlay._controls = {
                prev: tooltip.querySelector('.btn-tutorial-prev'),
                next: tooltip.querySelector('.btn-tutorial-next'),
                close: tooltip.querySelector('.btn-tutorial-close'),
                title: tooltip.querySelector('h3'),
                desc: tooltip.querySelector('p'),
                progress: tooltip.querySelector('.tutorial-progress')
            };
            return overlay;
        }

        function placeHighlight(iframeRect, localRect, step, idx, total) {
            const overlay = document.querySelector('.tutorial-overlay');
            if (!overlay) return;
            const box = overlay._frameBox;
            const hl = overlay._highlight;
            const tt = overlay._tooltip;
            const c = overlay._controls;

            // Caixa exatamente sobre o iframe (usar floats, sem arredondar)
            box.style.position = 'fixed';
            box.style.top = iframeRect.top + 'px';
            box.style.left = iframeRect.left + 'px';
            box.style.width = iframeRect.width + 'px';
            box.style.height = iframeRect.height + 'px';
            box.style.zIndex = 10000;

            // Highlight absoluto dentro do frameBox
            hl.style.top = localRect.top + 'px';
            hl.style.left = localRect.left + 'px';
            hl.style.width = localRect.width + 'px';
            hl.style.height = localRect.height + 'px';

            c.title.textContent = step.title || ('Passo ' + (idx + 1));
            c.desc.textContent = step.description || '';
            c.progress.textContent = (idx + 1) + ' / ' + total;
            c.prev.disabled = idx === 0;
            c.next.textContent = idx === total - 1 ? 'Concluir' : 'Pr√≥ximo';

            const margin = 12;
            let hvLeft = iframeRect.left + localRect.left;
            let hvTop = iframeRect.top + localRect.top;
            let hvWidth = localRect.width;
            let hvHeight = localRect.height;

            let ttLeft = hvLeft + hvWidth + margin;
            let ttTop = hvTop;

            tt.style.visibility = 'hidden';
            tt.style.left = '0px';
            tt.style.top = '0px';

            requestAnimationFrame(() => {
                const ttRect = tt.getBoundingClientRect();
                if (ttLeft + ttRect.width > window.innerWidth - 10) {
                    ttLeft = hvLeft;
                    ttTop = hvTop + hvHeight + margin;
                }
                if (ttTop + ttRect.height > window.innerHeight - 10) {
                    ttTop = hvTop - ttRect.height - margin;
                }
                tt.style.left = ttLeft + 'px';
                tt.style.top = ttTop + 'px';
                tt.style.visibility = 'visible';
            });
        }

        function patchTutorial() {
            if (window.__TutorialPatched) return;
            window.__TutorialPatched = true;

            const original = window.PortalTutorial;

            window.PortalTutorial = {
                startTutorial: async function(pageId) {
                    try {
                        const resp = await fetch(`/api/tutorials/page/${pageId}`);
                        if (!resp.ok) { alert('Nenhum tutorial dispon√≠vel para esta p√°gina'); return; }
                        const tutorial = await resp.json();
                        const steps = Array.isArray(tutorial.steps) ? tutorial.steps : [];
                        if (!steps.length) { alert('Tutorial sem passos'); return; }

                        const powerIframe = document.querySelector('#powerbiContainer iframe');
                        if (!powerIframe) { alert('Painel n√£o est√° carregado'); return; }

                        const overlay = makeOverlay();
                        let currentIndex = 0;
                        let ro = null;

                        const reposition = () => {
                            if (!document.body.contains(overlay)) return;
                            const iframeRect = powerIframe.getBoundingClientRect();
                            const iw = Math.max(1, iframeRect.width);
                            const ih = Math.max(1, iframeRect.height);
                            const hl = steps[currentIndex]?.highlight || {};
                            const localRect = computeLocalRect(hl, iw, ih);
                            placeHighlight(iframeRect, localRect, steps[currentIndex], currentIndex, steps.length);
                        };

                        const go = (delta) => {
                            currentIndex += delta;
                            if (currentIndex < 0) currentIndex = 0;
                            if (currentIndex >= steps.length) { close(); return; }
                            reposition();
                        };

                        const close = () => {
                            try {
                                window.removeEventListener('resize', reposition);
                                window.removeEventListener('scroll', reposition, true);
                                if (ro) ro.disconnect();
                                powerIframe.removeEventListener('load', reposition);
                            } catch (_) {}
                            if (document.body.contains(overlay)) document.body.removeChild(overlay);
                        };

                        overlay._controls.prev.onclick = () => go(-1);
                        overlay._controls.next.onclick = () => go(1);
                        overlay._controls.close.onclick = close;

                        window.addEventListener('resize', reposition);
                        window.addEventListener('scroll', reposition, true);
                        powerIframe.addEventListener('load', reposition);
                        if ('ResizeObserver' in window) {
                            ro = new ResizeObserver(() => reposition());
                            ro.observe(powerIframe);
                            if (powerIframe.parentElement) ro.observe(powerIframe.parentElement);
                        }

                        reposition();
                    } catch (e) {
                        console.error('[Tutorial] Erro ao iniciar:', e);
                        alert('Erro ao iniciar tutorial');
                    }
                }
            };

            window._OriginalPortalTutorial = original;
        }

        window.addEventListener('load', () => setTimeout(patchTutorial, 0));
    })();
    </script>
</body>
</html>