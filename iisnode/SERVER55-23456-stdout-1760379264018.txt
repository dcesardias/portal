Conectado ao SQL Server
Servidor rodando em http://undefined:\\.\pipe\1a7206aa-1703-4c3c-8722-fa6c5044a224
Acesse: http://localhost:\\.\pipe\1a7206aa-1703-4c3c-8722-fa6c5044a224
[2025-10-13T18:14:25.268Z] GET /api/pages
GET /api/pages - requester anonymous
[2025-10-13T18:14:25.287Z] GET /api/menu
GET /api/menu - requester anonymous
[2025-10-13T18:14:25.320Z] GET /api/config?cb=1760379265000
[2025-10-13T18:25:15.280Z] GET /api/data-dictionaries/active
[2025-10-13T18:25:15.312Z] POST /api/chat/ai-sql
[AI-SQL] Processando pergunta: "faça a comparacao entre cirurgias de escoliose, cirurgia de coluna e artroplastia ao longo dos meses em 2025"
[AI-SQL] Dicionário de dados: Presente
[AI-SQL] Prompt completo sendo enviado:
INSTRUÇÃO ABSOLUTA: Responda APENAS com a consulta SQL. Não adicione explicações, comentários ou texto extra.

        Você é um assistente especializado em gerar consultas SQL para SQL Server (T-SQL).

        DICIONÁRIO DE DADOS DAS TABELAS DISPONÍVEIS:
        {
  "tables": [
    {
      "name": "Atendimentos",
      "description": "Sempre somar a coluna qt_atendimentos para contagem de atendimentos.\nTabela de atendimentos realizados, \nCirurgias realizadas, \nProdutos entregues (Exceto TipoAtendimento = ESTATÍSTICA OFICINA), \nTerapias realizadas, \nExames realizados, \nAtendimentos Oficina (Somente TipoAtendimento = ESTATÍSTICA OFICINA)",
      "columns": [
        {
          "name": "Id",
          "type": "INT",
          "description": "ID do atendimento"
        },
        {
          "name": "DataAtendimento",
          "type": "DATETIME",
          "description": "Data e hora do atendimento"
        },
        {
          "name": "PacienteId",
          "type": "INT",
          "description": "ID do paciente"
        },
        {
          "name": "UnidadeNeg",
          "type": "VARCHAR(MAX)",
          "description": "Descrição da Unidade de Negócio (HOSPITAL,CENTRO DE REABILITAÇÃO,CENTRO MÉDICO,CENTRO DE TERAPIA,CENTRO DE DIAGNÓSTICO,OFICINA ORTOPEDICA,CÂMARA HIPERBÁRICA)"
        },
        {
          "name": "TipoAtendimento",
          "type": "INT",
          "description": "Tipo de atendimento (Tipo da Cirurgia, Setor do Centro de Reabilitação, Produtos da Oficina e etc.)\n\nAdministrativo  = CENTRO DE REABILITAÇÃO\nAmbulatório = CENTRO DE REABILITAÇÃO\nAparelhos = OFICINA ORTOPEDICA\nAparelhos - (Imobilizadores) = OFICINA ORTOPEDICA\nAparelhos - (Ortese Craniana) = OFICINA ORTOPEDICA\nAparelhos - (Ortese de Mão) = OFICINA ORTOPEDICA\nAparelhos Serviço = OFICINA ORTOPEDICA\nArte e Reabilitação = CENTRO DE REABILITAÇÃO\nAvaliação Global = CENTRO DE REABILITAÇÃO\nCDI - Eletroneuromiografia - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCDI - Laboratório de Marcha - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCDI - Raios X - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCDI - Ressonância Magnética - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCDI - Tomografia - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCDI - Ultrassonografia - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCDI - Urodinamica - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCDI - Videodeglutograma - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCirurgia Artroplastia de Joelho = HOSPITAL\nCirurgia Artroplastia de Quadril = HOSPITAL\nCirurgia Artroplastia Diversa = HOSPITAL\nCirurgia Artroscopia de Joelho = HOSPITAL\nCirurgia Artroscopia Diversa = HOSPITAL\nCirurgia bloqueio = HOSPITAL\nCirurgia Coluna = HOSPITAL\nCirurgia Diversa = HOSPITAL\nCirurgia Escoliose = HOSPITAL\nCirurgia Neuro = HOSPITAL\nCirurgia ortopédica = HOSPITAL\nCirurgia Trauma = HOSPITAL\nColete - 3D Rigo Cheneau = OFICINA ORTOPEDICA\nColete - TLSO = OFICINA ORTOPEDICA\nColetes Serviço = OFICINA ORTOPEDICA\nCONSULTA FATURAVEL = CENTRO MÉDICO\nCONSULTA NÃO FATURAVEL = CENTRO MÉDICO\nCurativo Sem Anestesia = CÂMARA HIPERBÁRICA\nCurativos em geral sem anestesia, exceto queimados = CÂMARA HIPERBÁRICA\nESTATÍSTICA OFICINA = OFICINA ORTOPEDICA\nFisioterapia = CENTRO DE REABILITAÇÃO\nFisioterapia Adulto = CENTRO DE REABILITAÇÃO\nFisioterapia Aquática = CENTRO DE REABILITAÇÃO\nFisioterapia Infantil = CENTRO DE REABILITAÇÃO\nFonoaudiologia = CENTRO DE REABILITAÇÃO\nFonoaudiologia Adulto = CENTRO DE REABILITAÇÃO\nFonoaudiologia Infantil = CENTRO DE REABILITAÇÃO\nGoteiras = OFICINA ORTOPEDICA\nGoteiras Serviço = OFICINA ORTOPEDICA\nMúsico Terapia = CENTRO DE REABILITAÇÃO\nOdontologia = CENTRO DE REABILITAÇÃO\nPacote de Oxigenoterapia hiperbárica (10 sessões) = CÂMARA HIPERBÁRICA\nPacote de Oxigenoterapia hiperbárica (5 sessões) = CÂMARA HIPERBÁRICA\nPedagogia = CENTRO DE REABILITAÇÃO\nPedagogia Infantil = CENTRO DE REABILITAÇÃO\nPROCEDIMENTOS = CENTRO MÉDICO\nProtese = OFICINA ORTOPEDICA\nProteses Serviço = OFICINA ORTOPEDICA\nPsicologia = CENTRO DE REABILITAÇÃO\nPsicologia Adulto = CENTRO DE REABILITAÇÃO\nPsicologia Infantil = CENTRO DE REABILITAÇÃO\nRecepção Adulto = CENTRO DE REABILITAÇÃO\nRecepção Centro Diagnostico - Ibirapuera = CENTRO DE DIAGNÓSTICO\nRevenda = OFICINA ORTOPEDICA\nRevenda - Cadeira de Banho = OFICINA ORTOPEDICA\nRevenda - Cadeiras = OFICINA ORTOPEDICA\nRevenda - Cadeiras Motorizadas = OFICINA ORTOPEDICA\nRevenda - Seating = OFICINA ORTOPEDICA\nRobotica = CENTRO DE REABILITAÇÃO\nSapataria = OFICINA ORTOPEDICA\nSapataria Serviço = OFICINA ORTOPEDICA\nSeating = OFICINA ORTOPEDICA\nSeating Serviços = OFICINA ORTOPEDICA\nServiço Social = CENTRO DE REABILITAÇÃO\nSessão de OHB (2 Horas)  = CÂMARA HIPERBÁRICA\nSessão de oxigenoterapia hiperbárica (por sessão de 2 horas) = CÂMARA HIPERBÁRICA\nTerapia Ocupacional = CENTRO DE REABILITAÇÃO\nTerapia Ocupacional Adulto = CENTRO DE REABILITAÇÃO\nTerapia Ocupacional Infantil = CENTRO DE REABILITAÇÃO\nTERAPIAS = CENTRO DE TERAPIA"
        },
        {
          "name": "qt_atendimento",
          "type": "INT",
          "description": "Quantidade de atendimentos para Camara Hiperbarica\nQuantidade de Cirurgias para o Hospital\nQuantidade de Exames para o centro de Diagnostico\nQuantidade de Terapias para o Centro de Terapia\nQuantidade de Consultas para o Centro Médico\nQuantidade de Produtos para a Oficina\nQuantidade de Atendimentos para Oficina quando a TipoAtendimento contiver ESTATÍSTICA, neste caso não considerar como Produto da Oficina"
        },
        {
          "name": "Estabelecimento",
          "type": "VARCHAR(MAX)",
          "description": "Descrição do Estabelecimento onde o atendimento aconteceu, podendo ser (AACD Ibirapuera\nAACD Mooca,\nAACD Osasco,\nAACD Recife,\nAACD Porto Alegre,\nAACD Uberlândia,\nAACD Mogi,\nAACD Lar Escola,\nAACD Poços de Caldas,\nAACD Sambura,\n)"
        },
        {
          "name": "TipoConvênio",
          "type": "VARCHAR(50)",
          "description": "Descrição dos tipos de convênios (Fonte Pagadora) dos atendimentos:\nConvênio\nParticular\nPrefeituras\nSem remuneração/filantrópicos\nSUS"
        },
        {
          "name": "Convênio",
          "type": "VARCHAR(MAX)",
          "description": "Descricao dos Convenios e ou Operadoras dos atendimentos:\n\nAfresp\nAmil Grupo\nAssefaz  \nBradesco Operadora de Planos Saúde\nBradesco Saúde\nCabesp\nCare Plus\nCET\nCondemat\nConvênio Pagador\nEconomus\nEstatística Oficina\nF.427 - Condeca  - Vida é Movimento Mooca\nF.563 - Conselho Estadual do Idoso\nF.645 - TF03/2025 - Funcriança/Porto Alegre\nFASC\nFLUXO DE URGÊNCIA E EMERGÊNCIA\nFSFX - Usisaúde\nFusex\nGama\nGRATUIDADE\nHapVida Notre Dame\nHBC SAUDE LTDA\nHospital Cruz Azul\nHospital Frei Galvão\nHSPM \nIamspe - HSPE\nMediservice\nMetrus\nOmint\nParticular\nPorto Seguro\nPostal Saúde\nPrefeitura de Caraguatatuba\nPrefeitura de Itupeva\nPrefeitura de São Caetano do Sul\nPrefeitura Municipal de Caçapava\nPrevent Senior\nPRODUTO EM GARANTIA\nSaúde ABAS\nSaúde Caixa\nSaúde Caixa - Rio Grande doSul\nSaúde Petrobrás\nSeguros Unimed\nSPA\nSul América\nSul América - Uberlândia\nSUS - Sistema Unico de Saude\nTotal MedCare (Hospital Adventista)\nUnimed CNU\nUnimed Intercambio\nVIVEST/ Fundação Cesp"
        }
      ]
    },
    {
      "name": "Pacientes",
      "description": "Tabela de pacientes",
      "columns": [
        {
          "name": "Id",
          "type": "INT",
          "description": "ID único do paciente"
        },
        {
          "name": "DataNascimento",
          "type": "DATE",
          "description": "Data de nascimento"
        },
        {
          "name": "CPF",
          "type": "VARCHAR",
          "description": "CPF do paciente"
        },
        {
          "name": "Sexo",
          "type": "VARCHAR(50)",
          "description": "Sexo ou Gênero dos pacientes"
        },
        {
          "name": "EstadoCivil",
          "type": "VARCHAR(200)",
          "description": "Estado Civil dos pacientes"
        },
        {
          "name": "Religiao",
          "type": "VARCHAR(200)",
          "description": "Religião dos pacientes"
        },
        {
          "name": "DS_ENDERECO",
          "type": "VARCHAR(MAX)",
          "description": "Descrição dos endereços dos pacientes\n* Tratar essa coluna com upper e remoção de acentuação antes de pesquisar.\n* Sempre pesquisar com LIKE e upper removendo acentuação."
        },
        {
          "name": "CD_CEP",
          "type": "VARCHAR(50)",
          "description": "CEP do Endereço dos pacientes"
        },
        {
          "name": "DS_BAIRRO",
          "type": "VARCHAR(200)",
          "description": "Descrição do Bairro do Endereço dos pacientes\n* Tratar essa coluna com upper e remoção de acentuação antes de pesquisar.\n* Sempre pesquisar com LIKE e upper removendo acentuação."
        },
        {
          "name": "Município",
          "type": "VARCHAR(MAX)",
          "description": "Município do Endereço dos pacientes\n* Tratar essa coluna com upper e remoção de acentuação antes de pesquisar.\n* Sempre pesquisar com LIKE e upper removendo acentuação."
        },
        {
          "name": "SG_ESTADO",
          "type": "VARCHAR(50)",
          "description": "Sigla do Estado do Endereço dos Pacientes"
        },
        {
          "name": "DS_MUNICIPIO_CEP",
          "type": "VARCHAR(MAX)",
          "description": "Descrição do Município do Endereço dos pacientes pelo CEP\n* Tratar essa coluna com upper e remoção de acentuação antes de pesquisar.\n* Sempre pesquisar com LIKE e upper removendo acentuação."
        }
      ]
    }
  ]
}

        REGRAS OBRIGATÓRIAS:
        1. Use APENAS comandos SELECT
        2. Para filtros de data, SEMPRE use as funções MONTH() e YEAR()
        3. Para contagens, use COUNT(*) com alias descritivo
        4. Use TOP 100 para limitar resultados quando necessário
        5. Evite SELECT *, prefira colunas específicas
        6. Se a pergunta mencionar dados que não existem no dicionário, responda: "DADOS_NAO_ENCONTRADOS"
        7. **NOVO: Para queries "TOP N ao longo do tempo", use CTE para filtrar primeiro:**
        Exemplo: "top 3 setores ao longo dos meses" deve gerar:
        WITH TopN AS (SELECT TOP N coluna FROM tabela GROUP BY coluna ORDER BY SUM(valor) DESC)
        SELECT mes, ano, coluna, SUM(valor) FROM tabela WHERE coluna IN (SELECT coluna FROM TopN) GROUP BY mes, ano, coluna ORDER BY ano, mes

        MAPEAMENTO DE MESES EM PORTUGUÊS (OBRIGATÓRIO):
        - janeiro = 1, fevereiro = 2, março = 3, abril = 4
        - maio = 5, junho = 6, julho = 7, agosto = 8
        - setembro = 9, outubro = 10, novembro = 11, dezembro = 12

        PERGUNTA DO USUÁRIO: faça a comparacao entre cirurgias de escoliose, cirurgia de coluna e artroplastia ao longo dos meses em 2025

        Gere APENAS a consulta SQL (sem explicações):
[AI-SQL] Iniciando conversa com Direct Line...
[AI-SQL] Conversa iniciada: JUBJGIJjJLW6hSvoOC745E-br
[AI-SQL] Enviando pergunta para o Copilot...
[AI-SQL] Pergunta enviada com sucesso
[AI-SQL] Aguardando resposta do Copilot...
[AI-SQL] Resposta recebida após 13 tentativas
[AI-SQL] Resposta completa do Copilot: "```sql
SELECT 
    MONTH(DataAtendimento) AS Mes,
    YEAR(DataAtendimento) AS Ano,
    TipoAtendimento,
    SUM(qt_atendimento) AS TotalAtendimentos
FROM 
    Atendimentos
WHERE 
    YEAR(DataAtendimento) = 2025
    AND TipoAtendimento IN ('Cirurgia Escoliose', 'Cirurgia Coluna', 'Cirurgia Artroplastia de Joelho', 'Cirurgia Artroplastia de Quadril', 'Cirurgia Artroplastia Diversa')
GROUP BY 
    MONTH(DataAtendimento), 
    YEAR(DataAtendimento), 
    TipoAtendimento
ORDER BY 
    Ano, 
    Mes, 
    TipoAtendimento;
```
O conteúdo gerado por IA pode estar incorreto"
[AI-SQL] Iniciando limpeza da resposta...
[AI-SQL] SQL extraída do bloco: "SELECT 
    MONTH(DataAtendimento) AS Mes,
    YEAR(DataAtendimento) AS Ano,
    TipoAtendimento,
    SUM(qt_atendimento) AS TotalAtendimentos
FROM 
    Atendimentos
WHERE 
    YEAR(DataAtendimento) = 2025
    AND TipoAtendimento IN ('Cirurgia Escoliose', 'Cirurgia Coluna', 'Cirurgia Artroplastia de Joelho', 'Cirurgia Artroplastia de Quadril', 'Cirurgia Artroplastia Diversa')
GROUP BY 
    MONTH(DataAtendimento), 
    YEAR(DataAtendimento), 
    TipoAtendimento
ORDER BY 
    Ano, 
    Mes, 
    TipoAtendimento;"
[AI-SQL] SQL após limpeza: "SELECT 
    MONTH(DataAtendimento) AS Mes,
    YEAR(DataAtendimento) AS Ano,
    TipoAtendimento,
    SUM(qt_atendimento) AS TotalAtendimentos
FROM 
    Atendimentos
WHERE 
    YEAR(DataAtendimento) = 2025
    AND TipoAtendimento IN ('Cirurgia Escoliose', 'Cirurgia Coluna', 'Cirurgia Artroplastia de Joelho', 'Cirurgia Artroplastia de Quadril', 'Cirurgia Artroplastia Diversa')
GROUP BY 
    MONTH(DataAtendimento), 
    YEAR(DataAtendimento), 
    TipoAtendimento
ORDER BY 
    Ano, 
    Mes, 
    TipoAtendimento;"
[AI-SQL] Validando sintaxe da SQL...
[AI-SQL] ✅ SQL válida gerada: SELECT 
    MONTH(DataAtendimento) AS Mes,
    YEAR(DataAtendimento) AS Ano,
    TipoAtendimento,
    SUM(qt_atendimento) AS TotalAtendimentos
FROM 
    Atendimentos
WHERE 
    YEAR(DataAtendimento) = 2025
    AND TipoAtendimento IN ('Cirurgia Escoliose', 'Cirurgia Coluna', 'Cirurgia Artroplastia de Joelho', 'Cirurgia Artroplastia de Quadril', 'Cirurgia Artroplastia Diversa')
GROUP BY 
    MONTH(DataAtendimento), 
    YEAR(DataAtendimento), 
    TipoAtendimento
ORDER BY 
    Ano, 
    Mes, 
    TipoAtendimento;
[2025-10-13T18:25:29.148Z] POST /api/chat/query
[2025-10-13T18:25:29.662Z] POST /api/chat/analyze
[ANALYZE] Solicitando análise ao Copilot...
[ANALYZE] Análise concluída com sucesso
[2025-10-13T18:26:10.534Z] POST /api/chat/generate-chart
[CHART-INTELLIGENT] Solicitando análise inteligente ao Copilot...
[CHART-INTELLIGENT] Resposta recebida: {
    "dataAnalysis": {
        "hasTemporalData": true,
        "temporalColumns": {
            "year": "Ano",
            "month": "Mes",
            "date": null
        },
        "hasCategoricalData": true,
        "categoricalColumn": "TipoAtendimento",
        "uniqueCategories": ["Cirurgia Escoliose", "Cirurgia Coluna", "Cirurgia Artroplastia de Joelho", "Cirurgia Artroplastia de Quadril", "Cirurgia Artroplastia Diversa"],
        "valueColumns": ["TotalAtendimentos"],
        "dataForm
[CHART-INTELLIGENT] Análise recebida: {
  "dataAnalysis": {
    "hasTemporalData": true,
    "temporalColumns": {
      "year": "Ano",
      "month": "Mes",
      "date": null
    },
    "hasCategoricalData": true,
    "categoricalColumn": "TipoAtendimento",
    "uniqueCategories": [
      "Cirurgia Escoliose",
      "Cirurgia Coluna",
      "Cirurgia Artroplastia de Joelho",
      "Cirurgia Artroplastia de Quadril",
      "Cirurgia Artroplastia Diversa"
    ],
    "valueColumns": [
      "TotalAtendimentos"
    ],
    "dataFormat": "long",
    "needsPivot": true,
    "pivotReason": "Precisa pivotar TipoAtendimento para colunas separadas, criando uma série por tipo de cirurgia"
  },
  "chartConfig": {
    "suitable": true,
    "chartType": "line",
    "xColumn": "Mes",
    "yColumn": [
      "Cirurgia Escoliose",
      "Cirurgia Coluna",
      "Cirurgia Artroplastia de Joelho",
      "Cirurgia Artroplastia de Quadril",
      "Cirurgia Artroplastia Diversa"
    ],
    "title": "Comparação entre cirurgias de escoliose, coluna e artroplastia ao longo dos meses em 2025",
    "reasoning": "Gráfico de linha é adequado para mostrar a evolução temporal de múltiplas categorias",
    "showVariation": true
  }
}
[CHART-INTELLIGENT] Criando coluna AnoMes
[CHART-INTELLIGENT] Aplicando pivot conforme análise do Copilot
[CHART-INTELLIGENT] Categorias para pivot: [
  'Cirurgia Escoliose',
  'Cirurgia Coluna',
  'Cirurgia Artroplastia de Joelho',
  'Cirurgia Artroplastia de Quadril',
  'Cirurgia Artroplastia Diversa'
]
[CHART-INTELLIGENT] Pivot concluído: {
  dateKey: 'AnoMes',
  pivotedColumns: [
    'Cirurgia_Artroplastia_de_Joelho',
    'Cirurgia_Artroplastia_de_Quadril',
    'Cirurgia_Artroplastia_Diversa',
    'Cirurgia_Coluna',
    'Cirurgia_Escoliose'
  ],
  primeiraLinha: {
    AnoMes: '2025-01',
    Ano: 2025,
    Mes: 1,
    Cirurgia_Artroplastia_de_Joelho: 12,
    Cirurgia_Artroplastia_de_Quadril: 19,
    Cirurgia_Artroplastia_Diversa: 1,
    Cirurgia_Coluna: 128,
    Cirurgia_Escoliose: 39
  }
}
[CHART-INTELLIGENT] Dados ordenados temporalmente
[CHART-INTELLIGENT] ✅ Gráfico configurado: {
  type: 'line',
  xColumn: 'AnoMes',
  yColumn: [
    'Cirurgia_Artroplastia_de_Joelho',
    'Cirurgia_Artroplastia_de_Quadril',
    'Cirurgia_Artroplastia_Diversa',
    'Cirurgia_Coluna',
    'Cirurgia_Escoliose'
  ],
  isMultiSeries: true,
  dataPoints: 10
}
