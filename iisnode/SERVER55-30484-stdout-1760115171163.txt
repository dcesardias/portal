Conectado ao SQL Server
Servidor rodando em http://undefined:\\.\pipe\71d495e3-c87a-43d8-9b88-7c127b9fb85a
Acesse: http://localhost:\\.\pipe\71d495e3-c87a-43d8-9b88-7c127b9fb85a
[2025-10-10T16:52:52.292Z] GET /favicon.ico
[2025-10-10T16:52:52.297Z] GET /api/verify-token
[2025-10-10T16:52:52.306Z] GET /api/pages
GET /api/pages - requester admin (id:1)
[2025-10-10T16:52:52.321Z] GET /api/menu
GET /api/menu - requester admin (id:1)
[2025-10-10T16:52:52.354Z] GET /api/config?cb=1760115172327
[2025-10-10T16:52:54.479Z] GET /api/data-dictionaries/active
[2025-10-10T16:52:54.497Z] POST /api/chat/ai-sql
[AI-SQL] Processando pergunta: "distribuicao do top 3 produtos da oficina em 2025"
[AI-SQL] Dicionário de dados: Presente
[AI-SQL] Prompt completo sendo enviado:
INSTRUÇÃO ABSOLUTA: Responda APENAS com a consulta SQL. Não adicione explicações, comentários ou texto extra.

        Você é um assistente especializado em gerar consultas SQL para SQL Server (T-SQL).

        DICIONÁRIO DE DADOS DAS TABELAS DISPONÍVEIS:
        {
  "tables": [
    {
      "name": "Atendimentos",
      "description": "Sempre somar a coluna qt_atendimentos para contagem de atendimentos.\nTabela de atendimentos realizados, \nCirurgias realizadas, \nProdutos entregues (Exceto TipoAtendimento = ESTATÍSTICA OFICINA), \nTerapias realizadas, \nExames realizados, \nAtendimentos Oficina (Somente TipoAtendimento = ESTATÍSTICA OFICINA)",
      "columns": [
        {
          "name": "Id",
          "type": "INT",
          "description": "ID do atendimento"
        },
        {
          "name": "DataAtendimento",
          "type": "DATETIME",
          "description": "Data e hora do atendimento"
        },
        {
          "name": "PacienteId",
          "type": "INT",
          "description": "ID do paciente"
        },
        {
          "name": "UnidadeNeg",
          "type": "VARCHAR(MAX)",
          "description": "Descrição da Unidade de Negócio (HOSPITAL,CENTRO DE REABILITAÇÃO,CENTRO MÉDICO,CENTRO DE TERAPIA,CENTRO DE DIAGNÓSTICO,OFICINA ORTOPEDICA,CÂMARA HIPERBÁRICA)"
        },
        {
          "name": "TipoAtendimento",
          "type": "INT",
          "description": "Tipo de atendimento (Tipo da Cirurgia, Setor do Centro de Reabilitação, Produtos da Oficina e etc.)\n\nAdministrativo  = CENTRO DE REABILITAÇÃO\nAmbulatório = CENTRO DE REABILITAÇÃO\nAparelhos = OFICINA ORTOPEDICA\nAparelhos - (Imobilizadores) = OFICINA ORTOPEDICA\nAparelhos - (Ortese Craniana) = OFICINA ORTOPEDICA\nAparelhos - (Ortese de Mão) = OFICINA ORTOPEDICA\nAparelhos Serviço = OFICINA ORTOPEDICA\nArte e Reabilitação = CENTRO DE REABILITAÇÃO\nAvaliação Global = CENTRO DE REABILITAÇÃO\nCDI - Eletroneuromiografia - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCDI - Laboratório de Marcha - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCDI - Raios X - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCDI - Ressonância Magnética - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCDI - Tomografia - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCDI - Ultrassonografia - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCDI - Urodinamica - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCDI - Videodeglutograma - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCirurgia Artroplastia de Joelho = HOSPITAL\nCirurgia Artroplastia de Quadril = HOSPITAL\nCirurgia Artroplastia Diversa = HOSPITAL\nCirurgia Artroscopia de Joelho = HOSPITAL\nCirurgia Artroscopia Diversa = HOSPITAL\nCirurgia bloqueio = HOSPITAL\nCirurgia Coluna = HOSPITAL\nCirurgia Diversa = HOSPITAL\nCirurgia Escoliose = HOSPITAL\nCirurgia Neuro = HOSPITAL\nCirurgia ortopédica = HOSPITAL\nCirurgia Trauma = HOSPITAL\nColete - 3D Rigo Cheneau = OFICINA ORTOPEDICA\nColete - TLSO = OFICINA ORTOPEDICA\nColetes Serviço = OFICINA ORTOPEDICA\nCONSULTA FATURAVEL = CENTRO MÉDICO\nCONSULTA NÃO FATURAVEL = CENTRO MÉDICO\nCurativo Sem Anestesia = CÂMARA HIPERBÁRICA\nCurativos em geral sem anestesia, exceto queimados = CÂMARA HIPERBÁRICA\nESTATÍSTICA OFICINA = OFICINA ORTOPEDICA\nFisioterapia = CENTRO DE REABILITAÇÃO\nFisioterapia Adulto = CENTRO DE REABILITAÇÃO\nFisioterapia Aquática = CENTRO DE REABILITAÇÃO\nFisioterapia Infantil = CENTRO DE REABILITAÇÃO\nFonoaudiologia = CENTRO DE REABILITAÇÃO\nFonoaudiologia Adulto = CENTRO DE REABILITAÇÃO\nFonoaudiologia Infantil = CENTRO DE REABILITAÇÃO\nGoteiras = OFICINA ORTOPEDICA\nGoteiras Serviço = OFICINA ORTOPEDICA\nMúsico Terapia = CENTRO DE REABILITAÇÃO\nOdontologia = CENTRO DE REABILITAÇÃO\nPacote de Oxigenoterapia hiperbárica (10 sessões) = CÂMARA HIPERBÁRICA\nPacote de Oxigenoterapia hiperbárica (5 sessões) = CÂMARA HIPERBÁRICA\nPedagogia = CENTRO DE REABILITAÇÃO\nPedagogia Infantil = CENTRO DE REABILITAÇÃO\nPROCEDIMENTOS = CENTRO MÉDICO\nProtese = OFICINA ORTOPEDICA\nProteses Serviço = OFICINA ORTOPEDICA\nPsicologia = CENTRO DE REABILITAÇÃO\nPsicologia Adulto = CENTRO DE REABILITAÇÃO\nPsicologia Infantil = CENTRO DE REABILITAÇÃO\nRecepção Adulto = CENTRO DE REABILITAÇÃO\nRecepção Centro Diagnostico - Ibirapuera = CENTRO DE DIAGNÓSTICO\nRevenda = OFICINA ORTOPEDICA\nRevenda - Cadeira de Banho = OFICINA ORTOPEDICA\nRevenda - Cadeiras = OFICINA ORTOPEDICA\nRevenda - Cadeiras Motorizadas = OFICINA ORTOPEDICA\nRevenda - Seating = OFICINA ORTOPEDICA\nRobotica = CENTRO DE REABILITAÇÃO\nSapataria = OFICINA ORTOPEDICA\nSapataria Serviço = OFICINA ORTOPEDICA\nSeating = OFICINA ORTOPEDICA\nSeating Serviços = OFICINA ORTOPEDICA\nServiço Social = CENTRO DE REABILITAÇÃO\nSessão de OHB (2 Horas)  = CÂMARA HIPERBÁRICA\nSessão de oxigenoterapia hiperbárica (por sessão de 2 horas) = CÂMARA HIPERBÁRICA\nTerapia Ocupacional = CENTRO DE REABILITAÇÃO\nTerapia Ocupacional Adulto = CENTRO DE REABILITAÇÃO\nTerapia Ocupacional Infantil = CENTRO DE REABILITAÇÃO\nTERAPIAS = CENTRO DE TERAPIA"
        },
        {
          "name": "qt_atendimento",
          "type": "INT",
          "description": "Quantidade de atendimentos para Camara Hiperbarica\nQuantidade de Cirurgias para o Hospital\nQuantidade de Exames para o centro de Diagnostico\nQuantidade de Terapias para o Centro de Terapia\nQuantidade de Consultas para o Centro Médico\nQuantidade de Produtos para a Oficina\nQuantidade de Atendimentos para Oficina quando a TipoAtendimento contiver ESTATÍSTICA, neste caso não considerar como Produto da Oficina"
        },
        {
          "name": "Estabelecimento",
          "type": "VARCHAR(MAX)",
          "description": "Descrição do Estabelecimento onde o atendimento aconteceu, podendo ser (AACD Ibirapuera\nAACD Mooca,\nAACD Osasco,\nAACD Recife,\nAACD Porto Alegre,\nAACD Uberlândia,\nAACD Mogi,\nAACD Lar Escola,\nAACD Poços de Caldas,\nAACD Sambura,\n)"
        }
      ]
    },
    {
      "name": "Pacientes",
      "description": "Tabela de pacientes",
      "columns": [
        {
          "name": "Id",
          "type": "INT",
          "description": "ID único do paciente"
        },
        {
          "name": "Nome",
          "type": "VARCHAR",
          "description": "Nome completo do paciente"
        },
        {
          "name": "DataNascimento",
          "type": "DATE",
          "description": "Data de nascimento"
        },
        {
          "name": "CPF",
          "type": "VARCHAR",
          "description": "CPF do paciente"
        }
      ]
    }
  ]
}

        REGRAS OBRIGATÓRIAS:
        1. Use APENAS comandos SELECT
        2. Para filtros de data, SEMPRE use as funções MONTH() e YEAR()
        3. Para contagens, use COUNT(*) com alias descritivo
        4. Use TOP 100 para limitar resultados quando necessário
        5. Evite SELECT *, prefira colunas específicas
        6. Se a pergunta mencionar dados que não existem no dicionário, responda: "DADOS_NAO_ENCONTRADOS"
        7. **NOVO: Para queries "TOP N ao longo do tempo", use CTE para filtrar primeiro:**
        Exemplo: "top 3 setores ao longo dos meses" deve gerar:
        WITH TopN AS (SELECT TOP N coluna FROM tabela GROUP BY coluna ORDER BY SUM(valor) DESC)
        SELECT mes, ano, coluna, SUM(valor) FROM tabela WHERE coluna IN (SELECT coluna FROM TopN) GROUP BY mes, ano, coluna ORDER BY ano, mes

        MAPEAMENTO DE MESES EM PORTUGUÊS (OBRIGATÓRIO):
        - janeiro = 1, fevereiro = 2, março = 3, abril = 4
        - maio = 5, junho = 6, julho = 7, agosto = 8
        - setembro = 9, outubro = 10, novembro = 11, dezembro = 12

        PERGUNTA DO USUÁRIO: distribuicao do top 3 produtos da oficina em 2025

        Gere APENAS a consulta SQL (sem explicações):
[AI-SQL] Iniciando conversa com Direct Line...
[AI-SQL] Conversa iniciada: J7rr1J9pBnN8UoiRsPsqFi-br
[AI-SQL] Enviando pergunta para o Copilot...
[AI-SQL] Pergunta enviada com sucesso
[AI-SQL] Aguardando resposta do Copilot...
[AI-SQL] Resposta recebida após 11 tentativas
[AI-SQL] Resposta completa do Copilot: "```sql
WITH Top3Produtos AS (
    SELECT TOP 3 TipoAtendimento
    FROM Atendimentos
    WHERE UnidadeNeg = 'OFICINA ORTOPEDICA' AND TipoAtendimento != 'ESTATÍSTICA OFICINA' AND YEAR(DataAtendimento) = 2025
    GROUP BY TipoAtendimento
    ORDER BY SUM(qt_atendimento) DESC
)
SELECT 
    MONTH(DataAtendimento) AS Mes,
    YEAR(DataAtendimento) AS Ano,
    TipoAtendimento,
    SUM(qt_atendimento) AS TotalAtendimentos
FROM 
    Atendimentos
WHERE 
    UnidadeNeg = 'OFICINA ORTOPEDICA' 
    AND TipoAtendimento IN (SELECT TipoAtendimento FROM Top3Produtos)
    AND YEAR(DataAtendimento) = 2025
GROUP BY 
    MONTH(DataAtendimento), YEAR(DataAtendimento), TipoAtendimento
ORDER BY 
    Ano, Mes;
```
O conteúdo gerado por IA pode estar incorreto"
[AI-SQL] Iniciando limpeza da resposta...
[AI-SQL] SQL extraída do bloco: "WITH Top3Produtos AS (
    SELECT TOP 3 TipoAtendimento
    FROM Atendimentos
    WHERE UnidadeNeg = 'OFICINA ORTOPEDICA' AND TipoAtendimento != 'ESTATÍSTICA OFICINA' AND YEAR(DataAtendimento) = 2025
    GROUP BY TipoAtendimento
    ORDER BY SUM(qt_atendimento) DESC
)
SELECT 
    MONTH(DataAtendimento) AS Mes,
    YEAR(DataAtendimento) AS Ano,
    TipoAtendimento,
    SUM(qt_atendimento) AS TotalAtendimentos
FROM 
    Atendimentos
WHERE 
    UnidadeNeg = 'OFICINA ORTOPEDICA' 
    AND TipoAtendimento IN (SELECT TipoAtendimento FROM Top3Produtos)
    AND YEAR(DataAtendimento) = 2025
GROUP BY 
    MONTH(DataAtendimento), YEAR(DataAtendimento), TipoAtendimento
ORDER BY 
    Ano, Mes;"
[AI-SQL] SQL após limpeza: "WITH Top3Produtos AS (
    SELECT TOP 3 TipoAtendimento
    FROM Atendimentos
    WHERE UnidadeNeg = 'OFICINA ORTOPEDICA' AND TipoAtendimento != 'ESTATÍSTICA OFICINA' AND YEAR(DataAtendimento) = 2025
    GROUP BY TipoAtendimento
    ORDER BY SUM(qt_atendimento) DESC
)
SELECT 
    MONTH(DataAtendimento) AS Mes,
    YEAR(DataAtendimento) AS Ano,
    TipoAtendimento,
    SUM(qt_atendimento) AS TotalAtendimentos
FROM 
    Atendimentos
WHERE 
    UnidadeNeg = 'OFICINA ORTOPEDICA' 
    AND TipoAtendimento IN (SELECT TipoAtendimento FROM Top3Produtos)
    AND YEAR(DataAtendimento) = 2025
GROUP BY 
    MONTH(DataAtendimento), YEAR(DataAtendimento), TipoAtendimento
ORDER BY 
    Ano, Mes;"
[AI-SQL] Validando sintaxe da SQL...
[SQL-VALIDATION] CTE detectada - validando com TOP 0
[SQL-VALIDATION] CTE validada com sucesso
[AI-SQL] ✅ SQL válida gerada: WITH Top3Produtos AS (
    SELECT TOP 3 TipoAtendimento
    FROM Atendimentos
    WHERE UnidadeNeg = 'OFICINA ORTOPEDICA' AND TipoAtendimento != 'ESTATÍSTICA OFICINA' AND YEAR(DataAtendimento) = 2025
    GROUP BY TipoAtendimento
    ORDER BY SUM(qt_atendimento) DESC
)
SELECT 
    MONTH(DataAtendimento) AS Mes,
    YEAR(DataAtendimento) AS Ano,
    TipoAtendimento,
    SUM(qt_atendimento) AS TotalAtendimentos
FROM 
    Atendimentos
WHERE 
    UnidadeNeg = 'OFICINA ORTOPEDICA' 
    AND TipoAtendimento IN (SELECT TipoAtendimento FROM Top3Produtos)
    AND YEAR(DataAtendimento) = 2025
GROUP BY 
    MONTH(DataAtendimento), YEAR(DataAtendimento), TipoAtendimento
ORDER BY 
    Ano, Mes;
[2025-10-10T16:53:05.736Z] POST /api/chat/query
[2025-10-10T16:53:06.373Z] POST /api/chat/analyze
[ANALYZE] Solicitando análise ao Copilot...
[ANALYZE] Análise concluída com sucesso
[2025-10-10T16:55:20.097Z] POST /api/chat/generate-chart
[CHART-INTELLIGENT] Solicitando análise inteligente ao Copilot...
[CHART-INTELLIGENT] Resposta recebida: {
    "dataAnalysis": {
        "hasTemporalData": true,
        "temporalColumns": {
            "year": "Ano",
            "month": "Mes",
            "date": null
        },
        "hasCategoricalData": true,
        "categoricalColumn": "TipoAtendimento",
        "uniqueCategories": ["Revenda - Cadeiras", "Goteiras", "Goteiras Serviço"],
        "valueColumns": ["TotalAtendimentos"],
        "dataFormat": "long",
        "needsPivot": true,
        "pivotReason": "Precisa pivotar TipoAtendi
[CHART-INTELLIGENT] Análise recebida: {
  "dataAnalysis": {
    "hasTemporalData": true,
    "temporalColumns": {
      "year": "Ano",
      "month": "Mes",
      "date": null
    },
    "hasCategoricalData": true,
    "categoricalColumn": "TipoAtendimento",
    "uniqueCategories": [
      "Revenda - Cadeiras",
      "Goteiras",
      "Goteiras Serviço"
    ],
    "valueColumns": [
      "TotalAtendimentos"
    ],
    "dataFormat": "long",
    "needsPivot": true,
    "pivotReason": "Precisa pivotar TipoAtendimento para colunas separadas, criando uma série por produto"
  },
  "chartConfig": {
    "suitable": true,
    "chartType": "line",
    "xColumn": "Mes",
    "yColumn": [
      "Revenda - Cadeiras",
      "Goteiras",
      "Goteiras Serviço"
    ],
    "title": "Evolução dos Top 3 Produtos da Oficina ao Longo dos Meses em 2025",
    "reasoning": "O gráfico de linha é adequado para mostrar a evolução temporal dos atendimentos dos três principais produtos ao longo dos meses.",
    "showVariation": true
  }
}
[CHART-INTELLIGENT] Criando coluna AnoMes
[CHART-INTELLIGENT] Aplicando pivot conforme análise do Copilot
[CHART-INTELLIGENT] Categorias para pivot: [ 'Revenda - Cadeiras', 'Goteiras', 'Goteiras Serviço' ]
[CHART-INTELLIGENT] Pivot concluído: {
  dateKey: 'AnoMes',
  pivotedColumns: [ 'Revenda__Cadeiras', 'Goteiras', 'Goteiras_Servio' ],
  primeiraLinha: {
    AnoMes: '2025-01',
    Ano: 2025,
    Mes: 1,
    Revenda__Cadeiras: 464,
    Goteiras: 589,
    Goteiras_Servio: 490
  }
}
[CHART-INTELLIGENT] Dados ordenados temporalmente
[CHART-INTELLIGENT] ✅ Gráfico configurado: {
  type: 'line',
  xColumn: 'AnoMes',
  yColumn: [ 'Revenda__Cadeiras', 'Goteiras', 'Goteiras_Servio' ],
  isMultiSeries: true,
  dataPoints: 10
}
[2025-10-10T16:56:08.577Z] GET /api/pages
GET /api/pages - requester anonymous
[2025-10-10T16:56:08.610Z] GET /api/menu
GET /api/menu - requester anonymous
[2025-10-10T16:56:08.628Z] GET /api/config?cb=1760115368459
[2025-10-10T16:56:26.030Z] GET /api/data-dictionaries/active
[2025-10-10T16:56:26.047Z] POST /api/chat/ai-sql
[AI-SQL] Processando pergunta: "Boa tarde, gostaria de saber a quantidade de pacientes menores de idade"
[AI-SQL] Dicionário de dados: Presente
[AI-SQL] Prompt completo sendo enviado:
INSTRUÇÃO ABSOLUTA: Responda APENAS com a consulta SQL. Não adicione explicações, comentários ou texto extra.

        Você é um assistente especializado em gerar consultas SQL para SQL Server (T-SQL).

        DICIONÁRIO DE DADOS DAS TABELAS DISPONÍVEIS:
        {
  "tables": [
    {
      "name": "Atendimentos",
      "description": "Sempre somar a coluna qt_atendimentos para contagem de atendimentos.\nTabela de atendimentos realizados, \nCirurgias realizadas, \nProdutos entregues (Exceto TipoAtendimento = ESTATÍSTICA OFICINA), \nTerapias realizadas, \nExames realizados, \nAtendimentos Oficina (Somente TipoAtendimento = ESTATÍSTICA OFICINA)",
      "columns": [
        {
          "name": "Id",
          "type": "INT",
          "description": "ID do atendimento"
        },
        {
          "name": "DataAtendimento",
          "type": "DATETIME",
          "description": "Data e hora do atendimento"
        },
        {
          "name": "PacienteId",
          "type": "INT",
          "description": "ID do paciente"
        },
        {
          "name": "UnidadeNeg",
          "type": "VARCHAR(MAX)",
          "description": "Descrição da Unidade de Negócio (HOSPITAL,CENTRO DE REABILITAÇÃO,CENTRO MÉDICO,CENTRO DE TERAPIA,CENTRO DE DIAGNÓSTICO,OFICINA ORTOPEDICA,CÂMARA HIPERBÁRICA)"
        },
        {
          "name": "TipoAtendimento",
          "type": "INT",
          "description": "Tipo de atendimento (Tipo da Cirurgia, Setor do Centro de Reabilitação, Produtos da Oficina e etc.)\n\nAdministrativo  = CENTRO DE REABILITAÇÃO\nAmbulatório = CENTRO DE REABILITAÇÃO\nAparelhos = OFICINA ORTOPEDICA\nAparelhos - (Imobilizadores) = OFICINA ORTOPEDICA\nAparelhos - (Ortese Craniana) = OFICINA ORTOPEDICA\nAparelhos - (Ortese de Mão) = OFICINA ORTOPEDICA\nAparelhos Serviço = OFICINA ORTOPEDICA\nArte e Reabilitação = CENTRO DE REABILITAÇÃO\nAvaliação Global = CENTRO DE REABILITAÇÃO\nCDI - Eletroneuromiografia - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCDI - Laboratório de Marcha - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCDI - Raios X - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCDI - Ressonância Magnética - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCDI - Tomografia - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCDI - Ultrassonografia - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCDI - Urodinamica - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCDI - Videodeglutograma - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCirurgia Artroplastia de Joelho = HOSPITAL\nCirurgia Artroplastia de Quadril = HOSPITAL\nCirurgia Artroplastia Diversa = HOSPITAL\nCirurgia Artroscopia de Joelho = HOSPITAL\nCirurgia Artroscopia Diversa = HOSPITAL\nCirurgia bloqueio = HOSPITAL\nCirurgia Coluna = HOSPITAL\nCirurgia Diversa = HOSPITAL\nCirurgia Escoliose = HOSPITAL\nCirurgia Neuro = HOSPITAL\nCirurgia ortopédica = HOSPITAL\nCirurgia Trauma = HOSPITAL\nColete - 3D Rigo Cheneau = OFICINA ORTOPEDICA\nColete - TLSO = OFICINA ORTOPEDICA\nColetes Serviço = OFICINA ORTOPEDICA\nCONSULTA FATURAVEL = CENTRO MÉDICO\nCONSULTA NÃO FATURAVEL = CENTRO MÉDICO\nCurativo Sem Anestesia = CÂMARA HIPERBÁRICA\nCurativos em geral sem anestesia, exceto queimados = CÂMARA HIPERBÁRICA\nESTATÍSTICA OFICINA = OFICINA ORTOPEDICA\nFisioterapia = CENTRO DE REABILITAÇÃO\nFisioterapia Adulto = CENTRO DE REABILITAÇÃO\nFisioterapia Aquática = CENTRO DE REABILITAÇÃO\nFisioterapia Infantil = CENTRO DE REABILITAÇÃO\nFonoaudiologia = CENTRO DE REABILITAÇÃO\nFonoaudiologia Adulto = CENTRO DE REABILITAÇÃO\nFonoaudiologia Infantil = CENTRO DE REABILITAÇÃO\nGoteiras = OFICINA ORTOPEDICA\nGoteiras Serviço = OFICINA ORTOPEDICA\nMúsico Terapia = CENTRO DE REABILITAÇÃO\nOdontologia = CENTRO DE REABILITAÇÃO\nPacote de Oxigenoterapia hiperbárica (10 sessões) = CÂMARA HIPERBÁRICA\nPacote de Oxigenoterapia hiperbárica (5 sessões) = CÂMARA HIPERBÁRICA\nPedagogia = CENTRO DE REABILITAÇÃO\nPedagogia Infantil = CENTRO DE REABILITAÇÃO\nPROCEDIMENTOS = CENTRO MÉDICO\nProtese = OFICINA ORTOPEDICA\nProteses Serviço = OFICINA ORTOPEDICA\nPsicologia = CENTRO DE REABILITAÇÃO\nPsicologia Adulto = CENTRO DE REABILITAÇÃO\nPsicologia Infantil = CENTRO DE REABILITAÇÃO\nRecepção Adulto = CENTRO DE REABILITAÇÃO\nRecepção Centro Diagnostico - Ibirapuera = CENTRO DE DIAGNÓSTICO\nRevenda = OFICINA ORTOPEDICA\nRevenda - Cadeira de Banho = OFICINA ORTOPEDICA\nRevenda - Cadeiras = OFICINA ORTOPEDICA\nRevenda - Cadeiras Motorizadas = OFICINA ORTOPEDICA\nRevenda - Seating = OFICINA ORTOPEDICA\nRobotica = CENTRO DE REABILITAÇÃO\nSapataria = OFICINA ORTOPEDICA\nSapataria Serviço = OFICINA ORTOPEDICA\nSeating = OFICINA ORTOPEDICA\nSeating Serviços = OFICINA ORTOPEDICA\nServiço Social = CENTRO DE REABILITAÇÃO\nSessão de OHB (2 Horas)  = CÂMARA HIPERBÁRICA\nSessão de oxigenoterapia hiperbárica (por sessão de 2 horas) = CÂMARA HIPERBÁRICA\nTerapia Ocupacional = CENTRO DE REABILITAÇÃO\nTerapia Ocupacional Adulto = CENTRO DE REABILITAÇÃO\nTerapia Ocupacional Infantil = CENTRO DE REABILITAÇÃO\nTERAPIAS = CENTRO DE TERAPIA"
        },
        {
          "name": "qt_atendimento",
          "type": "INT",
          "description": "Quantidade de atendimentos para Camara Hiperbarica\nQuantidade de Cirurgias para o Hospital\nQuantidade de Exames para o centro de Diagnostico\nQuantidade de Terapias para o Centro de Terapia\nQuantidade de Consultas para o Centro Médico\nQuantidade de Produtos para a Oficina\nQuantidade de Atendimentos para Oficina quando a TipoAtendimento contiver ESTATÍSTICA, neste caso não considerar como Produto da Oficina"
        },
        {
          "name": "Estabelecimento",
          "type": "VARCHAR(MAX)",
          "description": "Descrição do Estabelecimento onde o atendimento aconteceu, podendo ser (AACD Ibirapuera\nAACD Mooca,\nAACD Osasco,\nAACD Recife,\nAACD Porto Alegre,\nAACD Uberlândia,\nAACD Mogi,\nAACD Lar Escola,\nAACD Poços de Caldas,\nAACD Sambura,\n)"
        }
      ]
    },
    {
      "name": "Pacientes",
      "description": "Tabela de pacientes",
      "columns": [
        {
          "name": "Id",
          "type": "INT",
          "description": "ID único do paciente"
        },
        {
          "name": "Nome",
          "type": "VARCHAR",
          "description": "Nome completo do paciente"
        },
        {
          "name": "DataNascimento",
          "type": "DATE",
          "description": "Data de nascimento"
        },
        {
          "name": "CPF",
          "type": "VARCHAR",
          "description": "CPF do paciente"
        }
      ]
    }
  ]
}

        REGRAS OBRIGATÓRIAS:
        1. Use APENAS comandos SELECT
        2. Para filtros de data, SEMPRE use as funções MONTH() e YEAR()
        3. Para contagens, use COUNT(*) com alias descritivo
        4. Use TOP 100 para limitar resultados quando necessário
        5. Evite SELECT *, prefira colunas específicas
        6. Se a pergunta mencionar dados que não existem no dicionário, responda: "DADOS_NAO_ENCONTRADOS"
        7. **NOVO: Para queries "TOP N ao longo do tempo", use CTE para filtrar primeiro:**
        Exemplo: "top 3 setores ao longo dos meses" deve gerar:
        WITH TopN AS (SELECT TOP N coluna FROM tabela GROUP BY coluna ORDER BY SUM(valor) DESC)
        SELECT mes, ano, coluna, SUM(valor) FROM tabela WHERE coluna IN (SELECT coluna FROM TopN) GROUP BY mes, ano, coluna ORDER BY ano, mes

        MAPEAMENTO DE MESES EM PORTUGUÊS (OBRIGATÓRIO):
        - janeiro = 1, fevereiro = 2, março = 3, abril = 4
        - maio = 5, junho = 6, julho = 7, agosto = 8
        - setembro = 9, outubro = 10, novembro = 11, dezembro = 12

        PERGUNTA DO USUÁRIO: Boa tarde, gostaria de saber a quantidade de pacientes menores de idade

        Gere APENAS a consulta SQL (sem explicações):
[AI-SQL] Iniciando conversa com Direct Line...
[AI-SQL] Conversa iniciada: 5zY6wH2l61b9i5LDuIG7H4-br
[AI-SQL] Enviando pergunta para o Copilot...
[AI-SQL] Pergunta enviada com sucesso
[AI-SQL] Aguardando resposta do Copilot...
[AI-SQL] Resposta recebida após 8 tentativas
[AI-SQL] Resposta completa do Copilot: "```sql
SELECT COUNT(*) AS quantidade_pacientes_menores_idade
FROM Pacientes
WHERE DATEDIFF(YEAR, DataNascimento, GETDATE()) < 18
```
O conteúdo gerado por IA pode estar incorreto"
[AI-SQL] Iniciando limpeza da resposta...
[AI-SQL] SQL extraída do bloco: "SELECT COUNT(*) AS quantidade_pacientes_menores_idade
FROM Pacientes
WHERE DATEDIFF(YEAR, DataNascimento, GETDATE()) < 18"
[AI-SQL] SQL após limpeza: "SELECT COUNT(*) AS quantidade_pacientes_menores_idade
FROM Pacientes
WHERE DATEDIFF(YEAR, DataNascimento, GETDATE()) < 18"
[AI-SQL] Validando sintaxe da SQL...
[AI-SQL] ✅ SQL válida gerada: SELECT COUNT(*) AS quantidade_pacientes_menores_idade
FROM Pacientes
WHERE DATEDIFF(YEAR, DataNascimento, GETDATE()) < 18
[2025-10-10T16:56:33.864Z] POST /api/chat/query
[2025-10-10T16:56:33.921Z] POST /api/chat/analyze
[ANALYZE] Solicitando análise ao Copilot...
[ANALYZE] Análise concluída com sucesso
[2025-10-10T16:57:04.722Z] GET /api/data-dictionaries/active
[2025-10-10T16:57:04.739Z] POST /api/chat/ai-sql
[AI-SQL] Processando pergunta: "Evolutivo de cirurgias de escoliose"
[AI-SQL] Dicionário de dados: Presente
[AI-SQL] Prompt completo sendo enviado:
INSTRUÇÃO ABSOLUTA: Responda APENAS com a consulta SQL. Não adicione explicações, comentários ou texto extra.

        Você é um assistente especializado em gerar consultas SQL para SQL Server (T-SQL).

        DICIONÁRIO DE DADOS DAS TABELAS DISPONÍVEIS:
        {
  "tables": [
    {
      "name": "Atendimentos",
      "description": "Sempre somar a coluna qt_atendimentos para contagem de atendimentos.\nTabela de atendimentos realizados, \nCirurgias realizadas, \nProdutos entregues (Exceto TipoAtendimento = ESTATÍSTICA OFICINA), \nTerapias realizadas, \nExames realizados, \nAtendimentos Oficina (Somente TipoAtendimento = ESTATÍSTICA OFICINA)",
      "columns": [
        {
          "name": "Id",
          "type": "INT",
          "description": "ID do atendimento"
        },
        {
          "name": "DataAtendimento",
          "type": "DATETIME",
          "description": "Data e hora do atendimento"
        },
        {
          "name": "PacienteId",
          "type": "INT",
          "description": "ID do paciente"
        },
        {
          "name": "UnidadeNeg",
          "type": "VARCHAR(MAX)",
          "description": "Descrição da Unidade de Negócio (HOSPITAL,CENTRO DE REABILITAÇÃO,CENTRO MÉDICO,CENTRO DE TERAPIA,CENTRO DE DIAGNÓSTICO,OFICINA ORTOPEDICA,CÂMARA HIPERBÁRICA)"
        },
        {
          "name": "TipoAtendimento",
          "type": "INT",
          "description": "Tipo de atendimento (Tipo da Cirurgia, Setor do Centro de Reabilitação, Produtos da Oficina e etc.)\n\nAdministrativo  = CENTRO DE REABILITAÇÃO\nAmbulatório = CENTRO DE REABILITAÇÃO\nAparelhos = OFICINA ORTOPEDICA\nAparelhos - (Imobilizadores) = OFICINA ORTOPEDICA\nAparelhos - (Ortese Craniana) = OFICINA ORTOPEDICA\nAparelhos - (Ortese de Mão) = OFICINA ORTOPEDICA\nAparelhos Serviço = OFICINA ORTOPEDICA\nArte e Reabilitação = CENTRO DE REABILITAÇÃO\nAvaliação Global = CENTRO DE REABILITAÇÃO\nCDI - Eletroneuromiografia - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCDI - Laboratório de Marcha - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCDI - Raios X - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCDI - Ressonância Magnética - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCDI - Tomografia - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCDI - Ultrassonografia - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCDI - Urodinamica - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCDI - Videodeglutograma - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCirurgia Artroplastia de Joelho = HOSPITAL\nCirurgia Artroplastia de Quadril = HOSPITAL\nCirurgia Artroplastia Diversa = HOSPITAL\nCirurgia Artroscopia de Joelho = HOSPITAL\nCirurgia Artroscopia Diversa = HOSPITAL\nCirurgia bloqueio = HOSPITAL\nCirurgia Coluna = HOSPITAL\nCirurgia Diversa = HOSPITAL\nCirurgia Escoliose = HOSPITAL\nCirurgia Neuro = HOSPITAL\nCirurgia ortopédica = HOSPITAL\nCirurgia Trauma = HOSPITAL\nColete - 3D Rigo Cheneau = OFICINA ORTOPEDICA\nColete - TLSO = OFICINA ORTOPEDICA\nColetes Serviço = OFICINA ORTOPEDICA\nCONSULTA FATURAVEL = CENTRO MÉDICO\nCONSULTA NÃO FATURAVEL = CENTRO MÉDICO\nCurativo Sem Anestesia = CÂMARA HIPERBÁRICA\nCurativos em geral sem anestesia, exceto queimados = CÂMARA HIPERBÁRICA\nESTATÍSTICA OFICINA = OFICINA ORTOPEDICA\nFisioterapia = CENTRO DE REABILITAÇÃO\nFisioterapia Adulto = CENTRO DE REABILITAÇÃO\nFisioterapia Aquática = CENTRO DE REABILITAÇÃO\nFisioterapia Infantil = CENTRO DE REABILITAÇÃO\nFonoaudiologia = CENTRO DE REABILITAÇÃO\nFonoaudiologia Adulto = CENTRO DE REABILITAÇÃO\nFonoaudiologia Infantil = CENTRO DE REABILITAÇÃO\nGoteiras = OFICINA ORTOPEDICA\nGoteiras Serviço = OFICINA ORTOPEDICA\nMúsico Terapia = CENTRO DE REABILITAÇÃO\nOdontologia = CENTRO DE REABILITAÇÃO\nPacote de Oxigenoterapia hiperbárica (10 sessões) = CÂMARA HIPERBÁRICA\nPacote de Oxigenoterapia hiperbárica (5 sessões) = CÂMARA HIPERBÁRICA\nPedagogia = CENTRO DE REABILITAÇÃO\nPedagogia Infantil = CENTRO DE REABILITAÇÃO\nPROCEDIMENTOS = CENTRO MÉDICO\nProtese = OFICINA ORTOPEDICA\nProteses Serviço = OFICINA ORTOPEDICA\nPsicologia = CENTRO DE REABILITAÇÃO\nPsicologia Adulto = CENTRO DE REABILITAÇÃO\nPsicologia Infantil = CENTRO DE REABILITAÇÃO\nRecepção Adulto = CENTRO DE REABILITAÇÃO\nRecepção Centro Diagnostico - Ibirapuera = CENTRO DE DIAGNÓSTICO\nRevenda = OFICINA ORTOPEDICA\nRevenda - Cadeira de Banho = OFICINA ORTOPEDICA\nRevenda - Cadeiras = OFICINA ORTOPEDICA\nRevenda - Cadeiras Motorizadas = OFICINA ORTOPEDICA\nRevenda - Seating = OFICINA ORTOPEDICA\nRobotica = CENTRO DE REABILITAÇÃO\nSapataria = OFICINA ORTOPEDICA\nSapataria Serviço = OFICINA ORTOPEDICA\nSeating = OFICINA ORTOPEDICA\nSeating Serviços = OFICINA ORTOPEDICA\nServiço Social = CENTRO DE REABILITAÇÃO\nSessão de OHB (2 Horas)  = CÂMARA HIPERBÁRICA\nSessão de oxigenoterapia hiperbárica (por sessão de 2 horas) = CÂMARA HIPERBÁRICA\nTerapia Ocupacional = CENTRO DE REABILITAÇÃO\nTerapia Ocupacional Adulto = CENTRO DE REABILITAÇÃO\nTerapia Ocupacional Infantil = CENTRO DE REABILITAÇÃO\nTERAPIAS = CENTRO DE TERAPIA"
        },
        {
          "name": "qt_atendimento",
          "type": "INT",
          "description": "Quantidade de atendimentos para Camara Hiperbarica\nQuantidade de Cirurgias para o Hospital\nQuantidade de Exames para o centro de Diagnostico\nQuantidade de Terapias para o Centro de Terapia\nQuantidade de Consultas para o Centro Médico\nQuantidade de Produtos para a Oficina\nQuantidade de Atendimentos para Oficina quando a TipoAtendimento contiver ESTATÍSTICA, neste caso não considerar como Produto da Oficina"
        },
        {
          "name": "Estabelecimento",
          "type": "VARCHAR(MAX)",
          "description": "Descrição do Estabelecimento onde o atendimento aconteceu, podendo ser (AACD Ibirapuera\nAACD Mooca,\nAACD Osasco,\nAACD Recife,\nAACD Porto Alegre,\nAACD Uberlândia,\nAACD Mogi,\nAACD Lar Escola,\nAACD Poços de Caldas,\nAACD Sambura,\n)"
        }
      ]
    },
    {
      "name": "Pacientes",
      "description": "Tabela de pacientes",
      "columns": [
        {
          "name": "Id",
          "type": "INT",
          "description": "ID único do paciente"
        },
        {
          "name": "Nome",
          "type": "VARCHAR",
          "description": "Nome completo do paciente"
        },
        {
          "name": "DataNascimento",
          "type": "DATE",
          "description": "Data de nascimento"
        },
        {
          "name": "CPF",
          "type": "VARCHAR",
          "description": "CPF do paciente"
        }
      ]
    }
  ]
}

        REGRAS OBRIGATÓRIAS:
        1. Use APENAS comandos SELECT
        2. Para filtros de data, SEMPRE use as funções MONTH() e YEAR()
        3. Para contagens, use COUNT(*) com alias descritivo
        4. Use TOP 100 para limitar resultados quando necessário
        5. Evite SELECT *, prefira colunas específicas
        6. Se a pergunta mencionar dados que não existem no dicionário, responda: "DADOS_NAO_ENCONTRADOS"
        7. **NOVO: Para queries "TOP N ao longo do tempo", use CTE para filtrar primeiro:**
        Exemplo: "top 3 setores ao longo dos meses" deve gerar:
        WITH TopN AS (SELECT TOP N coluna FROM tabela GROUP BY coluna ORDER BY SUM(valor) DESC)
        SELECT mes, ano, coluna, SUM(valor) FROM tabela WHERE coluna IN (SELECT coluna FROM TopN) GROUP BY mes, ano, coluna ORDER BY ano, mes

        MAPEAMENTO DE MESES EM PORTUGUÊS (OBRIGATÓRIO):
        - janeiro = 1, fevereiro = 2, março = 3, abril = 4
        - maio = 5, junho = 6, julho = 7, agosto = 8
        - setembro = 9, outubro = 10, novembro = 11, dezembro = 12

        PERGUNTA DO USUÁRIO: Evolutivo de cirurgias de escoliose

        Gere APENAS a consulta SQL (sem explicações):
[AI-SQL] Iniciando conversa com Direct Line...
[AI-SQL] Conversa iniciada: 9YMgUvQiM1QFSRCqJPGRbX-br
[AI-SQL] Enviando pergunta para o Copilot...
[AI-SQL] Pergunta enviada com sucesso
[AI-SQL] Aguardando resposta do Copilot...
[AI-SQL] Resposta recebida após 8 tentativas
[AI-SQL] Resposta completa do Copilot: "```sql
SELECT 
    YEAR(DataAtendimento) AS Ano, 
    MONTH(DataAtendimento) AS Mes, 
    SUM(qt_atendimento) AS TotalCirurgiasEscoliose
FROM 
    Atendimentos
WHERE 
    TipoAtendimento = 'Cirurgia Escoliose'
GROUP BY 
    YEAR(DataAtendimento), 
    MONTH(DataAtendimento)
ORDER BY 
    Ano, 
    Mes
```
O conteúdo gerado por IA pode estar incorreto"
[AI-SQL] Iniciando limpeza da resposta...
[AI-SQL] SQL extraída do bloco: "SELECT 
    YEAR(DataAtendimento) AS Ano, 
    MONTH(DataAtendimento) AS Mes, 
    SUM(qt_atendimento) AS TotalCirurgiasEscoliose
FROM 
    Atendimentos
WHERE 
    TipoAtendimento = 'Cirurgia Escoliose'
GROUP BY 
    YEAR(DataAtendimento), 
    MONTH(DataAtendimento)
ORDER BY 
    Ano, 
    Mes"
[AI-SQL] SQL após limpeza: "SELECT 
    YEAR(DataAtendimento) AS Ano, 
    MONTH(DataAtendimento) AS Mes, 
    SUM(qt_atendimento) AS TotalCirurgiasEscoliose
FROM 
    Atendimentos
WHERE 
    TipoAtendimento = 'Cirurgia Escoliose'
GROUP BY 
    YEAR(DataAtendimento), 
    MONTH(DataAtendimento)
ORDER BY 
    Ano, 
    Mes"
[AI-SQL] Validando sintaxe da SQL...
[AI-SQL] ✅ SQL válida gerada: SELECT 
    YEAR(DataAtendimento) AS Ano, 
    MONTH(DataAtendimento) AS Mes, 
    SUM(qt_atendimento) AS TotalCirurgiasEscoliose
FROM 
    Atendimentos
WHERE 
    TipoAtendimento = 'Cirurgia Escoliose'
GROUP BY 
    YEAR(DataAtendimento), 
    MONTH(DataAtendimento)
ORDER BY 
    Ano, 
    Mes
[2025-10-10T16:57:12.502Z] POST /api/chat/query
[2025-10-10T16:57:12.803Z] POST /api/chat/analyze
[ANALYZE] Solicitando análise ao Copilot...
[ANALYZE] Análise concluída com sucesso
[2025-10-10T16:57:33.535Z] POST /api/chat/generate-chart
[CHART-INTELLIGENT] Solicitando análise inteligente ao Copilot...
[CHART-INTELLIGENT] Resposta recebida: {
    "dataAnalysis": {
        "hasTemporalData": true,
        "temporalColumns": {
            "year": "Ano",
            "month": "Mes",
            "date": null
        },
        "hasCategoricalData": false,
        "categoricalColumn": null,
        "uniqueCategories": [],
        "valueColumns": ["TotalCirurgiasEscoliose"],
        "dataFormat": "long",
        "needsPivot": false,
        "pivotReason": "Os dados já estão em formato longo e não há múltiplas categorias para comparar."
  
[CHART-INTELLIGENT] Análise recebida: {
  "dataAnalysis": {
    "hasTemporalData": true,
    "temporalColumns": {
      "year": "Ano",
      "month": "Mes",
      "date": null
    },
    "hasCategoricalData": false,
    "categoricalColumn": null,
    "uniqueCategories": [],
    "valueColumns": [
      "TotalCirurgiasEscoliose"
    ],
    "dataFormat": "long",
    "needsPivot": false,
    "pivotReason": "Os dados já estão em formato longo e não há múltiplas categorias para comparar."
  },
  "chartConfig": {
    "suitable": true,
    "chartType": "line",
    "xColumn": "Ano",
    "yColumn": "TotalCirurgiasEscoliose",
    "title": "Evolução das Cirurgias de Escoliose (2023-2025)",
    "reasoning": "Um gráfico de linha é adequado para visualizar a evolução temporal das cirurgias de escoliose ao longo dos anos.",
    "showVariation": true
  }
}
[CHART-INTELLIGENT] Criando coluna AnoMes
[CHART-INTELLIGENT] Dados ordenados temporalmente
[CHART-INTELLIGENT] ✅ Gráfico configurado: {
  type: 'line',
  xColumn: 'AnoMes',
  yColumn: 'TotalCirurgiasEscoliose',
  isMultiSeries: false,
  dataPoints: 34
}
[2025-10-10T16:58:48.480Z] GET /api/data-dictionaries/active
[2025-10-10T16:58:48.506Z] POST /api/chat/ai-sql
[AI-SQL] Processando pergunta: "Evolução de atendimento de pacientes com mais de 60 anos"
[AI-SQL] Dicionário de dados: Presente
[AI-SQL] Prompt completo sendo enviado:
INSTRUÇÃO ABSOLUTA: Responda APENAS com a consulta SQL. Não adicione explicações, comentários ou texto extra.

        Você é um assistente especializado em gerar consultas SQL para SQL Server (T-SQL).

        DICIONÁRIO DE DADOS DAS TABELAS DISPONÍVEIS:
        {
  "tables": [
    {
      "name": "Atendimentos",
      "description": "Sempre somar a coluna qt_atendimentos para contagem de atendimentos.\nTabela de atendimentos realizados, \nCirurgias realizadas, \nProdutos entregues (Exceto TipoAtendimento = ESTATÍSTICA OFICINA), \nTerapias realizadas, \nExames realizados, \nAtendimentos Oficina (Somente TipoAtendimento = ESTATÍSTICA OFICINA)",
      "columns": [
        {
          "name": "Id",
          "type": "INT",
          "description": "ID do atendimento"
        },
        {
          "name": "DataAtendimento",
          "type": "DATETIME",
          "description": "Data e hora do atendimento"
        },
        {
          "name": "PacienteId",
          "type": "INT",
          "description": "ID do paciente"
        },
        {
          "name": "UnidadeNeg",
          "type": "VARCHAR(MAX)",
          "description": "Descrição da Unidade de Negócio (HOSPITAL,CENTRO DE REABILITAÇÃO,CENTRO MÉDICO,CENTRO DE TERAPIA,CENTRO DE DIAGNÓSTICO,OFICINA ORTOPEDICA,CÂMARA HIPERBÁRICA)"
        },
        {
          "name": "TipoAtendimento",
          "type": "INT",
          "description": "Tipo de atendimento (Tipo da Cirurgia, Setor do Centro de Reabilitação, Produtos da Oficina e etc.)\n\nAdministrativo  = CENTRO DE REABILITAÇÃO\nAmbulatório = CENTRO DE REABILITAÇÃO\nAparelhos = OFICINA ORTOPEDICA\nAparelhos - (Imobilizadores) = OFICINA ORTOPEDICA\nAparelhos - (Ortese Craniana) = OFICINA ORTOPEDICA\nAparelhos - (Ortese de Mão) = OFICINA ORTOPEDICA\nAparelhos Serviço = OFICINA ORTOPEDICA\nArte e Reabilitação = CENTRO DE REABILITAÇÃO\nAvaliação Global = CENTRO DE REABILITAÇÃO\nCDI - Eletroneuromiografia - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCDI - Laboratório de Marcha - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCDI - Raios X - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCDI - Ressonância Magnética - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCDI - Tomografia - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCDI - Ultrassonografia - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCDI - Urodinamica - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCDI - Videodeglutograma - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCirurgia Artroplastia de Joelho = HOSPITAL\nCirurgia Artroplastia de Quadril = HOSPITAL\nCirurgia Artroplastia Diversa = HOSPITAL\nCirurgia Artroscopia de Joelho = HOSPITAL\nCirurgia Artroscopia Diversa = HOSPITAL\nCirurgia bloqueio = HOSPITAL\nCirurgia Coluna = HOSPITAL\nCirurgia Diversa = HOSPITAL\nCirurgia Escoliose = HOSPITAL\nCirurgia Neuro = HOSPITAL\nCirurgia ortopédica = HOSPITAL\nCirurgia Trauma = HOSPITAL\nColete - 3D Rigo Cheneau = OFICINA ORTOPEDICA\nColete - TLSO = OFICINA ORTOPEDICA\nColetes Serviço = OFICINA ORTOPEDICA\nCONSULTA FATURAVEL = CENTRO MÉDICO\nCONSULTA NÃO FATURAVEL = CENTRO MÉDICO\nCurativo Sem Anestesia = CÂMARA HIPERBÁRICA\nCurativos em geral sem anestesia, exceto queimados = CÂMARA HIPERBÁRICA\nESTATÍSTICA OFICINA = OFICINA ORTOPEDICA\nFisioterapia = CENTRO DE REABILITAÇÃO\nFisioterapia Adulto = CENTRO DE REABILITAÇÃO\nFisioterapia Aquática = CENTRO DE REABILITAÇÃO\nFisioterapia Infantil = CENTRO DE REABILITAÇÃO\nFonoaudiologia = CENTRO DE REABILITAÇÃO\nFonoaudiologia Adulto = CENTRO DE REABILITAÇÃO\nFonoaudiologia Infantil = CENTRO DE REABILITAÇÃO\nGoteiras = OFICINA ORTOPEDICA\nGoteiras Serviço = OFICINA ORTOPEDICA\nMúsico Terapia = CENTRO DE REABILITAÇÃO\nOdontologia = CENTRO DE REABILITAÇÃO\nPacote de Oxigenoterapia hiperbárica (10 sessões) = CÂMARA HIPERBÁRICA\nPacote de Oxigenoterapia hiperbárica (5 sessões) = CÂMARA HIPERBÁRICA\nPedagogia = CENTRO DE REABILITAÇÃO\nPedagogia Infantil = CENTRO DE REABILITAÇÃO\nPROCEDIMENTOS = CENTRO MÉDICO\nProtese = OFICINA ORTOPEDICA\nProteses Serviço = OFICINA ORTOPEDICA\nPsicologia = CENTRO DE REABILITAÇÃO\nPsicologia Adulto = CENTRO DE REABILITAÇÃO\nPsicologia Infantil = CENTRO DE REABILITAÇÃO\nRecepção Adulto = CENTRO DE REABILITAÇÃO\nRecepção Centro Diagnostico - Ibirapuera = CENTRO DE DIAGNÓSTICO\nRevenda = OFICINA ORTOPEDICA\nRevenda - Cadeira de Banho = OFICINA ORTOPEDICA\nRevenda - Cadeiras = OFICINA ORTOPEDICA\nRevenda - Cadeiras Motorizadas = OFICINA ORTOPEDICA\nRevenda - Seating = OFICINA ORTOPEDICA\nRobotica = CENTRO DE REABILITAÇÃO\nSapataria = OFICINA ORTOPEDICA\nSapataria Serviço = OFICINA ORTOPEDICA\nSeating = OFICINA ORTOPEDICA\nSeating Serviços = OFICINA ORTOPEDICA\nServiço Social = CENTRO DE REABILITAÇÃO\nSessão de OHB (2 Horas)  = CÂMARA HIPERBÁRICA\nSessão de oxigenoterapia hiperbárica (por sessão de 2 horas) = CÂMARA HIPERBÁRICA\nTerapia Ocupacional = CENTRO DE REABILITAÇÃO\nTerapia Ocupacional Adulto = CENTRO DE REABILITAÇÃO\nTerapia Ocupacional Infantil = CENTRO DE REABILITAÇÃO\nTERAPIAS = CENTRO DE TERAPIA"
        },
        {
          "name": "qt_atendimento",
          "type": "INT",
          "description": "Quantidade de atendimentos para Camara Hiperbarica\nQuantidade de Cirurgias para o Hospital\nQuantidade de Exames para o centro de Diagnostico\nQuantidade de Terapias para o Centro de Terapia\nQuantidade de Consultas para o Centro Médico\nQuantidade de Produtos para a Oficina\nQuantidade de Atendimentos para Oficina quando a TipoAtendimento contiver ESTATÍSTICA, neste caso não considerar como Produto da Oficina"
        },
        {
          "name": "Estabelecimento",
          "type": "VARCHAR(MAX)",
          "description": "Descrição do Estabelecimento onde o atendimento aconteceu, podendo ser (AACD Ibirapuera\nAACD Mooca,\nAACD Osasco,\nAACD Recife,\nAACD Porto Alegre,\nAACD Uberlândia,\nAACD Mogi,\nAACD Lar Escola,\nAACD Poços de Caldas,\nAACD Sambura,\n)"
        }
      ]
    },
    {
      "name": "Pacientes",
      "description": "Tabela de pacientes",
      "columns": [
        {
          "name": "Id",
          "type": "INT",
          "description": "ID único do paciente"
        },
        {
          "name": "Nome",
          "type": "VARCHAR",
          "description": "Nome completo do paciente"
        },
        {
          "name": "DataNascimento",
          "type": "DATE",
          "description": "Data de nascimento"
        },
        {
          "name": "CPF",
          "type": "VARCHAR",
          "description": "CPF do paciente"
        }
      ]
    }
  ]
}

        REGRAS OBRIGATÓRIAS:
        1. Use APENAS comandos SELECT
        2. Para filtros de data, SEMPRE use as funções MONTH() e YEAR()
        3. Para contagens, use COUNT(*) com alias descritivo
        4. Use TOP 100 para limitar resultados quando necessário
        5. Evite SELECT *, prefira colunas específicas
        6. Se a pergunta mencionar dados que não existem no dicionário, responda: "DADOS_NAO_ENCONTRADOS"
        7. **NOVO: Para queries "TOP N ao longo do tempo", use CTE para filtrar primeiro:**
        Exemplo: "top 3 setores ao longo dos meses" deve gerar:
        WITH TopN AS (SELECT TOP N coluna FROM tabela GROUP BY coluna ORDER BY SUM(valor) DESC)
        SELECT mes, ano, coluna, SUM(valor) FROM tabela WHERE coluna IN (SELECT coluna FROM TopN) GROUP BY mes, ano, coluna ORDER BY ano, mes

        MAPEAMENTO DE MESES EM PORTUGUÊS (OBRIGATÓRIO):
        - janeiro = 1, fevereiro = 2, março = 3, abril = 4
        - maio = 5, junho = 6, julho = 7, agosto = 8
        - setembro = 9, outubro = 10, novembro = 11, dezembro = 12

        PERGUNTA DO USUÁRIO: Evolução de atendimento de pacientes com mais de 60 anos

        Gere APENAS a consulta SQL (sem explicações):
[AI-SQL] Iniciando conversa com Direct Line...
[AI-SQL] Conversa iniciada: B0B8MMwdd4TA3CN6ZGMgnk-br
[AI-SQL] Enviando pergunta para o Copilot...
[AI-SQL] Pergunta enviada com sucesso
[AI-SQL] Aguardando resposta do Copilot...
[AI-SQL] Resposta recebida após 10 tentativas
[AI-SQL] Resposta completa do Copilot: "```sql
SELECT 
    YEAR(A.DataAtendimento) AS Ano, 
    MONTH(A.DataAtendimento) AS Mes, 
    SUM(A.qt_atendimento) AS TotalAtendimentos
FROM 
    Atendimentos A
JOIN 
    Pacientes P ON A.PacienteId = P.Id
WHERE 
    DATEDIFF(YEAR, P.DataNascimento, A.DataAtendimento) > 60
GROUP BY 
    YEAR(A.DataAtendimento), 
    MONTH(A.DataAtendimento)
ORDER BY 
    Ano, Mes
```
O conteúdo gerado por IA pode estar incorreto"
[AI-SQL] Iniciando limpeza da resposta...
[AI-SQL] SQL extraída do bloco: "SELECT 
    YEAR(A.DataAtendimento) AS Ano, 
    MONTH(A.DataAtendimento) AS Mes, 
    SUM(A.qt_atendimento) AS TotalAtendimentos
FROM 
    Atendimentos A
JOIN 
    Pacientes P ON A.PacienteId = P.Id
WHERE 
    DATEDIFF(YEAR, P.DataNascimento, A.DataAtendimento) > 60
GROUP BY 
    YEAR(A.DataAtendimento), 
    MONTH(A.DataAtendimento)
ORDER BY 
    Ano, Mes"
[AI-SQL] SQL após limpeza: "SELECT 
    YEAR(A.DataAtendimento) AS Ano, 
    MONTH(A.DataAtendimento) AS Mes, 
    SUM(A.qt_atendimento) AS TotalAtendimentos
FROM 
    Atendimentos A
JOIN 
    Pacientes P ON A.PacienteId = P.Id
WHERE 
    DATEDIFF(YEAR, P.DataNascimento, A.DataAtendimento) > 60
GROUP BY 
    YEAR(A.DataAtendimento), 
    MONTH(A.DataAtendimento)
ORDER BY 
    Ano, Mes"
[AI-SQL] Validando sintaxe da SQL...
[AI-SQL] ✅ SQL válida gerada: SELECT 
    YEAR(A.DataAtendimento) AS Ano, 
    MONTH(A.DataAtendimento) AS Mes, 
    SUM(A.qt_atendimento) AS TotalAtendimentos
FROM 
    Atendimentos A
JOIN 
    Pacientes P ON A.PacienteId = P.Id
WHERE 
    DATEDIFF(YEAR, P.DataNascimento, A.DataAtendimento) > 60
GROUP BY 
    YEAR(A.DataAtendimento), 
    MONTH(A.DataAtendimento)
ORDER BY 
    Ano, Mes
[2025-10-10T16:58:58.575Z] POST /api/chat/query
[2025-10-10T16:58:58.922Z] POST /api/chat/analyze
[ANALYZE] Solicitando análise ao Copilot...
[ANALYZE] Análise concluída com sucesso
[2025-10-10T16:59:22.854Z] POST /api/chat/generate-chart
[CHART-INTELLIGENT] Solicitando análise inteligente ao Copilot...
[CHART-INTELLIGENT] Resposta recebida: {
    "dataAnalysis": {
        "hasTemporalData": true,
        "temporalColumns": {
            "year": "Ano",
            "month": "Mes",
            "date": null
        },
        "hasCategoricalData": false,
        "categoricalColumn": null,
        "uniqueCategories": [],
        "valueColumns": ["TotalAtendimentos"],
        "dataFormat": "long",
        "needsPivot": false,
        "pivotReason": "Os dados já estão no formato adequado para análise temporal sem necessidade de pivot."
  
[CHART-INTELLIGENT] Análise recebida: {
  "dataAnalysis": {
    "hasTemporalData": true,
    "temporalColumns": {
      "year": "Ano",
      "month": "Mes",
      "date": null
    },
    "hasCategoricalData": false,
    "categoricalColumn": null,
    "uniqueCategories": [],
    "valueColumns": [
      "TotalAtendimentos"
    ],
    "dataFormat": "long",
    "needsPivot": false,
    "pivotReason": "Os dados já estão no formato adequado para análise temporal sem necessidade de pivot."
  },
  "chartConfig": {
    "suitable": true,
    "chartType": "line",
    "xColumn": "Ano",
    "yColumn": "TotalAtendimentos",
    "title": "Evolução de atendimento de pacientes com mais de 60 anos (2023-2025)",
    "reasoning": "O gráfico de linha é adequado para visualizar a evolução temporal dos atendimentos ao longo dos anos e meses.",
    "showVariation": true
  }
}
[CHART-INTELLIGENT] Criando coluna AnoMes
[CHART-INTELLIGENT] Dados ordenados temporalmente
[CHART-INTELLIGENT] ✅ Gráfico configurado: {
  type: 'line',
  xColumn: 'AnoMes',
  yColumn: 'TotalAtendimentos',
  isMultiSeries: false,
  dataPoints: 34
}
[2025-10-10T17:00:01.112Z] GET /api/data-dictionaries/active
[2025-10-10T17:00:01.140Z] POST /api/chat/ai-sql
[AI-SQL] Processando pergunta: "Quantidade de atendimento por faixa etária"
[AI-SQL] Dicionário de dados: Presente
[AI-SQL] Prompt completo sendo enviado:
INSTRUÇÃO ABSOLUTA: Responda APENAS com a consulta SQL. Não adicione explicações, comentários ou texto extra.

        Você é um assistente especializado em gerar consultas SQL para SQL Server (T-SQL).

        DICIONÁRIO DE DADOS DAS TABELAS DISPONÍVEIS:
        {
  "tables": [
    {
      "name": "Atendimentos",
      "description": "Sempre somar a coluna qt_atendimentos para contagem de atendimentos.\nTabela de atendimentos realizados, \nCirurgias realizadas, \nProdutos entregues (Exceto TipoAtendimento = ESTATÍSTICA OFICINA), \nTerapias realizadas, \nExames realizados, \nAtendimentos Oficina (Somente TipoAtendimento = ESTATÍSTICA OFICINA)",
      "columns": [
        {
          "name": "Id",
          "type": "INT",
          "description": "ID do atendimento"
        },
        {
          "name": "DataAtendimento",
          "type": "DATETIME",
          "description": "Data e hora do atendimento"
        },
        {
          "name": "PacienteId",
          "type": "INT",
          "description": "ID do paciente"
        },
        {
          "name": "UnidadeNeg",
          "type": "VARCHAR(MAX)",
          "description": "Descrição da Unidade de Negócio (HOSPITAL,CENTRO DE REABILITAÇÃO,CENTRO MÉDICO,CENTRO DE TERAPIA,CENTRO DE DIAGNÓSTICO,OFICINA ORTOPEDICA,CÂMARA HIPERBÁRICA)"
        },
        {
          "name": "TipoAtendimento",
          "type": "INT",
          "description": "Tipo de atendimento (Tipo da Cirurgia, Setor do Centro de Reabilitação, Produtos da Oficina e etc.)\n\nAdministrativo  = CENTRO DE REABILITAÇÃO\nAmbulatório = CENTRO DE REABILITAÇÃO\nAparelhos = OFICINA ORTOPEDICA\nAparelhos - (Imobilizadores) = OFICINA ORTOPEDICA\nAparelhos - (Ortese Craniana) = OFICINA ORTOPEDICA\nAparelhos - (Ortese de Mão) = OFICINA ORTOPEDICA\nAparelhos Serviço = OFICINA ORTOPEDICA\nArte e Reabilitação = CENTRO DE REABILITAÇÃO\nAvaliação Global = CENTRO DE REABILITAÇÃO\nCDI - Eletroneuromiografia - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCDI - Laboratório de Marcha - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCDI - Raios X - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCDI - Ressonância Magnética - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCDI - Tomografia - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCDI - Ultrassonografia - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCDI - Urodinamica - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCDI - Videodeglutograma - Ibirapuera = CENTRO DE DIAGNÓSTICO\nCirurgia Artroplastia de Joelho = HOSPITAL\nCirurgia Artroplastia de Quadril = HOSPITAL\nCirurgia Artroplastia Diversa = HOSPITAL\nCirurgia Artroscopia de Joelho = HOSPITAL\nCirurgia Artroscopia Diversa = HOSPITAL\nCirurgia bloqueio = HOSPITAL\nCirurgia Coluna = HOSPITAL\nCirurgia Diversa = HOSPITAL\nCirurgia Escoliose = HOSPITAL\nCirurgia Neuro = HOSPITAL\nCirurgia ortopédica = HOSPITAL\nCirurgia Trauma = HOSPITAL\nColete - 3D Rigo Cheneau = OFICINA ORTOPEDICA\nColete - TLSO = OFICINA ORTOPEDICA\nColetes Serviço = OFICINA ORTOPEDICA\nCONSULTA FATURAVEL = CENTRO MÉDICO\nCONSULTA NÃO FATURAVEL = CENTRO MÉDICO\nCurativo Sem Anestesia = CÂMARA HIPERBÁRICA\nCurativos em geral sem anestesia, exceto queimados = CÂMARA HIPERBÁRICA\nESTATÍSTICA OFICINA = OFICINA ORTOPEDICA\nFisioterapia = CENTRO DE REABILITAÇÃO\nFisioterapia Adulto = CENTRO DE REABILITAÇÃO\nFisioterapia Aquática = CENTRO DE REABILITAÇÃO\nFisioterapia Infantil = CENTRO DE REABILITAÇÃO\nFonoaudiologia = CENTRO DE REABILITAÇÃO\nFonoaudiologia Adulto = CENTRO DE REABILITAÇÃO\nFonoaudiologia Infantil = CENTRO DE REABILITAÇÃO\nGoteiras = OFICINA ORTOPEDICA\nGoteiras Serviço = OFICINA ORTOPEDICA\nMúsico Terapia = CENTRO DE REABILITAÇÃO\nOdontologia = CENTRO DE REABILITAÇÃO\nPacote de Oxigenoterapia hiperbárica (10 sessões) = CÂMARA HIPERBÁRICA\nPacote de Oxigenoterapia hiperbárica (5 sessões) = CÂMARA HIPERBÁRICA\nPedagogia = CENTRO DE REABILITAÇÃO\nPedagogia Infantil = CENTRO DE REABILITAÇÃO\nPROCEDIMENTOS = CENTRO MÉDICO\nProtese = OFICINA ORTOPEDICA\nProteses Serviço = OFICINA ORTOPEDICA\nPsicologia = CENTRO DE REABILITAÇÃO\nPsicologia Adulto = CENTRO DE REABILITAÇÃO\nPsicologia Infantil = CENTRO DE REABILITAÇÃO\nRecepção Adulto = CENTRO DE REABILITAÇÃO\nRecepção Centro Diagnostico - Ibirapuera = CENTRO DE DIAGNÓSTICO\nRevenda = OFICINA ORTOPEDICA\nRevenda - Cadeira de Banho = OFICINA ORTOPEDICA\nRevenda - Cadeiras = OFICINA ORTOPEDICA\nRevenda - Cadeiras Motorizadas = OFICINA ORTOPEDICA\nRevenda - Seating = OFICINA ORTOPEDICA\nRobotica = CENTRO DE REABILITAÇÃO\nSapataria = OFICINA ORTOPEDICA\nSapataria Serviço = OFICINA ORTOPEDICA\nSeating = OFICINA ORTOPEDICA\nSeating Serviços = OFICINA ORTOPEDICA\nServiço Social = CENTRO DE REABILITAÇÃO\nSessão de OHB (2 Horas)  = CÂMARA HIPERBÁRICA\nSessão de oxigenoterapia hiperbárica (por sessão de 2 horas) = CÂMARA HIPERBÁRICA\nTerapia Ocupacional = CENTRO DE REABILITAÇÃO\nTerapia Ocupacional Adulto = CENTRO DE REABILITAÇÃO\nTerapia Ocupacional Infantil = CENTRO DE REABILITAÇÃO\nTERAPIAS = CENTRO DE TERAPIA"
        },
        {
          "name": "qt_atendimento",
          "type": "INT",
          "description": "Quantidade de atendimentos para Camara Hiperbarica\nQuantidade de Cirurgias para o Hospital\nQuantidade de Exames para o centro de Diagnostico\nQuantidade de Terapias para o Centro de Terapia\nQuantidade de Consultas para o Centro Médico\nQuantidade de Produtos para a Oficina\nQuantidade de Atendimentos para Oficina quando a TipoAtendimento contiver ESTATÍSTICA, neste caso não considerar como Produto da Oficina"
        },
        {
          "name": "Estabelecimento",
          "type": "VARCHAR(MAX)",
          "description": "Descrição do Estabelecimento onde o atendimento aconteceu, podendo ser (AACD Ibirapuera\nAACD Mooca,\nAACD Osasco,\nAACD Recife,\nAACD Porto Alegre,\nAACD Uberlândia,\nAACD Mogi,\nAACD Lar Escola,\nAACD Poços de Caldas,\nAACD Sambura,\n)"
        }
      ]
    },
    {
      "name": "Pacientes",
      "description": "Tabela de pacientes",
      "columns": [
        {
          "name": "Id",
          "type": "INT",
          "description": "ID único do paciente"
        },
        {
          "name": "Nome",
          "type": "VARCHAR",
          "description": "Nome completo do paciente"
        },
        {
          "name": "DataNascimento",
          "type": "DATE",
          "description": "Data de nascimento"
        },
        {
          "name": "CPF",
          "type": "VARCHAR",
          "description": "CPF do paciente"
        }
      ]
    }
  ]
}

        REGRAS OBRIGATÓRIAS:
        1. Use APENAS comandos SELECT
        2. Para filtros de data, SEMPRE use as funções MONTH() e YEAR()
        3. Para contagens, use COUNT(*) com alias descritivo
        4. Use TOP 100 para limitar resultados quando necessário
        5. Evite SELECT *, prefira colunas específicas
        6. Se a pergunta mencionar dados que não existem no dicionário, responda: "DADOS_NAO_ENCONTRADOS"
        7. **NOVO: Para queries "TOP N ao longo do tempo", use CTE para filtrar primeiro:**
        Exemplo: "top 3 setores ao longo dos meses" deve gerar:
        WITH TopN AS (SELECT TOP N coluna FROM tabela GROUP BY coluna ORDER BY SUM(valor) DESC)
        SELECT mes, ano, coluna, SUM(valor) FROM tabela WHERE coluna IN (SELECT coluna FROM TopN) GROUP BY mes, ano, coluna ORDER BY ano, mes

        MAPEAMENTO DE MESES EM PORTUGUÊS (OBRIGATÓRIO):
        - janeiro = 1, fevereiro = 2, março = 3, abril = 4
        - maio = 5, junho = 6, julho = 7, agosto = 8
        - setembro = 9, outubro = 10, novembro = 11, dezembro = 12

        PERGUNTA DO USUÁRIO: Quantidade de atendimento por faixa etária

        Gere APENAS a consulta SQL (sem explicações):
[AI-SQL] Iniciando conversa com Direct Line...
[AI-SQL] Conversa iniciada: HdOavcPT2qUEpzs3y38Rpn-br
[AI-SQL] Enviando pergunta para o Copilot...
[AI-SQL] Pergunta enviada com sucesso
[AI-SQL] Aguardando resposta do Copilot...
[AI-SQL] Resposta recebida após 14 tentativas
[AI-SQL] Resposta completa do Copilot: "```sql
SELECT 
    CASE 
        WHEN DATEDIFF(YEAR, p.DataNascimento, GETDATE()) < 18 THEN '0-17'
        WHEN DATEDIFF(YEAR, p.DataNascimento, GETDATE()) BETWEEN 18 AND 35 THEN '18-35'
        WHEN DATEDIFF(YEAR, p.DataNascimento, GETDATE()) BETWEEN 36 AND 50 THEN '36-50'
        WHEN DATEDIFF(YEAR, p.DataNascimento, GETDATE()) BETWEEN 51 AND 65 THEN '51-65'
        ELSE '66+' 
    END AS FaixaEtaria,
    SUM(a.qt_atendimento) AS QuantidadeAtendimentos
FROM 
    Atendimentos a
JOIN 
    Pacientes p ON a.PacienteId = p.Id
GROUP BY 
    CASE 
        WHEN DATEDIFF(YEAR, p.DataNascimento, GETDATE()) < 18 THEN '0-17'
        WHEN DATEDIFF(YEAR, p.DataNascimento, GETDATE()) BETWEEN 18 AND 35 THEN '18-35'
        WHEN DATEDIFF(YEAR, p.DataNascimento, GETDATE()) BETWEEN 36 AND 50 THEN '36-50'
        WHEN DATEDIFF(YEAR, p.DataNascimento, GETDATE()) BETWEEN 51 AND 65 THEN '51-65'
        ELSE '66+' 
    END
```
O conteúdo gerado por IA pode estar incorreto"
[AI-SQL] Iniciando limpeza da resposta...
[AI-SQL] SQL extraída do bloco: "SELECT 
    CASE 
        WHEN DATEDIFF(YEAR, p.DataNascimento, GETDATE()) < 18 THEN '0-17'
        WHEN DATEDIFF(YEAR, p.DataNascimento, GETDATE()) BETWEEN 18 AND 35 THEN '18-35'
        WHEN DATEDIFF(YEAR, p.DataNascimento, GETDATE()) BETWEEN 36 AND 50 THEN '36-50'
        WHEN DATEDIFF(YEAR, p.DataNascimento, GETDATE()) BETWEEN 51 AND 65 THEN '51-65'
        ELSE '66+' 
    END AS FaixaEtaria,
    SUM(a.qt_atendimento) AS QuantidadeAtendimentos
FROM 
    Atendimentos a
JOIN 
    Pacientes p ON a.PacienteId = p.Id
GROUP BY 
    CASE 
        WHEN DATEDIFF(YEAR, p.DataNascimento, GETDATE()) < 18 THEN '0-17'
        WHEN DATEDIFF(YEAR, p.DataNascimento, GETDATE()) BETWEEN 18 AND 35 THEN '18-35'
        WHEN DATEDIFF(YEAR, p.DataNascimento, GETDATE()) BETWEEN 36 AND 50 THEN '36-50'
        WHEN DATEDIFF(YEAR, p.DataNascimento, GETDATE()) BETWEEN 51 AND 65 THEN '51-65'
        ELSE '66+' 
    END"
[AI-SQL] SQL após limpeza: "SELECT 
    CASE 
        WHEN DATEDIFF(YEAR, p.DataNascimento, GETDATE()) < 18 THEN '0-17'
        WHEN DATEDIFF(YEAR, p.DataNascimento, GETDATE()) BETWEEN 18 AND 35 THEN '18-35'
        WHEN DATEDIFF(YEAR, p.DataNascimento, GETDATE()) BETWEEN 36 AND 50 THEN '36-50'
        WHEN DATEDIFF(YEAR, p.DataNascimento, GETDATE()) BETWEEN 51 AND 65 THEN '51-65'
        ELSE '66+' 
    END AS FaixaEtaria,
    SUM(a.qt_atendimento) AS QuantidadeAtendimentos
FROM 
    Atendimentos a
JOIN 
    Pacientes p ON a.PacienteId = p.Id
GROUP BY 
    CASE 
        WHEN DATEDIFF(YEAR, p.DataNascimento, GETDATE()) < 18 THEN '0-17'
        WHEN DATEDIFF(YEAR, p.DataNascimento, GETDATE()) BETWEEN 18 AND 35 THEN '18-35'
        WHEN DATEDIFF(YEAR, p.DataNascimento, GETDATE()) BETWEEN 36 AND 50 THEN '36-50'
        WHEN DATEDIFF(YEAR, p.DataNascimento, GETDATE()) BETWEEN 51 AND 65 THEN '51-65'
        ELSE '66+' 
    END"
[AI-SQL] Validando sintaxe da SQL...
[AI-SQL] ✅ SQL válida gerada: SELECT 
    CASE 
        WHEN DATEDIFF(YEAR, p.DataNascimento, GETDATE()) < 18 THEN '0-17'
        WHEN DATEDIFF(YEAR, p.DataNascimento, GETDATE()) BETWEEN 18 AND 35 THEN '18-35'
        WHEN DATEDIFF(YEAR, p.DataNascimento, GETDATE()) BETWEEN 36 AND 50 THEN '36-50'
        WHEN DATEDIFF(YEAR, p.DataNascimento, GETDATE()) BETWEEN 51 AND 65 THEN '51-65'
        ELSE '66+' 
    END AS FaixaEtaria,
    SUM(a.qt_atendimento) AS QuantidadeAtendimentos
FROM 
    Atendimentos a
JOIN 
    Pacientes p ON a.PacienteId = p.Id
GROUP BY 
    CASE 
        WHEN DATEDIFF(YEAR, p.DataNascimento, GETDATE()) < 18 THEN '0-17'
        WHEN DATEDIFF(YEAR, p.DataNascimento, GETDATE()) BETWEEN 18 AND 35 THEN '18-35'
        WHEN DATEDIFF(YEAR, p.DataNascimento, GETDATE()) BETWEEN 36 AND 50 THEN '36-50'
        WHEN DATEDIFF(YEAR, p.DataNascimento, GETDATE()) BETWEEN 51 AND 65 THEN '51-65'
        ELSE '66+' 
    END
[2025-10-10T17:00:15.311Z] POST /api/chat/query
[2025-10-10T17:00:15.792Z] POST /api/chat/analyze
[ANALYZE] Solicitando análise ao Copilot...
[ANALYZE] Análise concluída com sucesso
[2025-10-10T17:00:25.053Z] POST /api/chat/generate-chart
[CHART-INTELLIGENT] Solicitando análise inteligente ao Copilot...
[CHART-INTELLIGENT] Resposta recebida: {
    "dataAnalysis": {
        "hasTemporalData": false,
        "temporalColumns": {
            "year": null,
            "month": null,
            "date": null
        },
        "hasCategoricalData": true,
        "categoricalColumn": "FaixaEtaria",
        "uniqueCategories": ["0-17", "18-35", "36-50", "51-65", "66+"],
        "valueColumns": ["QuantidadeAtendimentos"],
        "dataFormat": "wide",
        "needsPivot": false,
        "pivotReason": "Os dados já estão no formato largo, c
[CHART-INTELLIGENT] Análise recebida: {
  "dataAnalysis": {
    "hasTemporalData": false,
    "temporalColumns": {
      "year": null,
      "month": null,
      "date": null
    },
    "hasCategoricalData": true,
    "categoricalColumn": "FaixaEtaria",
    "uniqueCategories": [
      "0-17",
      "18-35",
      "36-50",
      "51-65",
      "66+"
    ],
    "valueColumns": [
      "QuantidadeAtendimentos"
    ],
    "dataFormat": "wide",
    "needsPivot": false,
    "pivotReason": "Os dados já estão no formato largo, com cada faixa etária representada em uma linha separada."
  },
  "chartConfig": {
    "suitable": true,
    "chartType": "bar",
    "xColumn": "FaixaEtaria",
    "yColumn": "QuantidadeAtendimentos",
    "title": "Quantidade de Atendimentos por Faixa Etária",
    "reasoning": "O gráfico de barras é adequado para comparar a quantidade de atendimentos entre diferentes faixas etárias.",
    "showVariation": false
  }
}
[CHART-INTELLIGENT] ✅ Gráfico configurado: {
  type: 'bar',
  xColumn: 'FaixaEtaria',
  yColumn: 'QuantidadeAtendimentos',
  isMultiSeries: false,
  dataPoints: 5
}
